<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Scene*Writer Mobile</title>
    <!-- PWAË®≠ÂÆö -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7c5b53">

<!-- iOSÂØæÂøú -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Scene*Writer">
<link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html, body { 
            font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
            background: transparent; 
            width: 100%; 
            height: 100%; 
            overflow: hidden;
            touch-action: manipulation;
        }
        
        /* „Ç¢„Éó„É™„Ç≥„É≥„ÉÜ„Éä */
        .app-container { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            height: 100vh;
            background-color: #f5f5f5;
        }
        
        /* „Éò„ÉÉ„ÉÄ„Éº - „Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
        .header { 
            background: linear-gradient(to right, #7c5b53, #a0795f); 
            color: white; 
            padding: 10px 15px;
            display: flex; 
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            font-size: 18px;
            font-weight: bold;
        }
        .header-actions {
            display: flex;
            gap: 8px;
        }
        .header-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        .header-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #e7d0a9;
        }
        .header-stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„Éë„Éç„É´ - Êäò„Çä„Åü„Åü„ÅøÂèØËÉΩ */
        .project-panel {
            background: white;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        .project-panel.collapsed {
            max-height: 0;
            padding: 0 12px;
        }
        .project-info-item {
            margin-bottom: 8px;
        }
        .project-info-item:last-child {
            margin-bottom: 0;
        }
        .project-label {
            font-size: 10px;
            color: #7c5b53;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .project-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #c4a88b;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        .project-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #c4a88b;
            border-radius: 8px;
            font-size: 13px;
            resize: none;
            min-height: 60px;
            background: white;
        }
        
        /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .tab-nav {
            display: flex;
            background: white;
            border-bottom: 2px solid #c4a88b;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #999;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab-btn.active {
            color: #7c5b53;
            border-bottom-color: #7c5b53;
        }
        
        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* „Ç®„Éá„Ç£„Çø„Éº„Çø„Éñ */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .editor-toolbar {
            background: #f8f8f8;
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .editor-toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .char-count {
            font-size: 12px;
            color: #666;
        }
        .char-button-panel {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .char-button {
            padding: 5px 10px;
            background: #8b6a5b;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
        }
        .tool-button-panel {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            padding-top: 4px;
            border-top: 1px solid #e0e0e0;
        }
        .tool-button-mini {
            padding: 4px 8px;
            border: none;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .tool-mini-green { background: #6b8b5a; }
        .tool-mini-brown { background: #8b6a5b; }
        .tool-mini-pink { background: #c85a8b; }
        .tool-mini-red { background: #b85a6b; }
        .tool-mini-beige { background: #a87b5a; }
        .editor-textarea {
            flex: 1;
            font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
            font-size: 15px;
            border: none;
            padding: 15px;
            resize: none;
            line-height: 1.8;
        }
        
        /* „Ç∑„Éº„É≥ÈÅ∏Êäû„Çø„Éñ */
        .scene-list {
            flex: 1;
            overflow-y: auto;
            background: white;
        }
        .scene-controls {
            padding: 12px;
            background: #f8f8f8;
            border-bottom: 1px solid #e0e0e0;
        }
        .scene-count-group {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }
        .scene-count-label {
            font-size: 12px;
            font-weight: bold;
            color: #7c5b53;
        }
        .scene-count-select {
            flex: 1;
            padding: 8px;
            border: 1px solid #c4a88b;
            border-radius: 8px;
            font-size: 14px;
        }
        .scene-apply-btn {
            padding: 8px 16px;
            background: #7c5b53;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        .scene-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .scene-item:active {
            background: #f0f0f0;
        }
        .scene-item.active {
            background: #D9BF9F;
            border-left: 4px solid #7c5b53;
        }
        .scene-name {
            font-size: 15px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .scene-stats {
            font-size: 12px;
            color: #666;
        }
        
        /* „ÉÑ„Éº„É´„Çø„Éñ */
        .tools-container {
            padding: 15px;
            background: white;
        }
        .tool-section {
            margin-bottom: 20px;
        }
        .tool-section-title {
            font-size: 14px;
            font-weight: bold;
            color: #7c5b53;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e7d0a9;
        }
        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .tool-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tool-btn-brown { background: #7c5b53; color: white; }
        .tool-btn-green { background: #6b8b5a; color: white; }
        .tool-btn-pink { background: #c85a8b; color: white; }
        .tool-btn-red { background: #b85a6b; color: white; }
        .tool-btn-beige { background: #a87b5a; color: white; }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        /* „É°„É¢„Çø„Éñ */
        .memo-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .memo-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-bottom: 8px solid #f5f5f5;
        }
        .memo-section:last-child {
            border-bottom: none;
        }
        .memo-title {
            font-size: 14px;
            font-weight: bold;
            color: #7c5b53;
            margin-bottom: 8px;
        }
        .memo-textarea {
            flex: 1;
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            line-height: 1.6;
            background: white;
        }
        
        /* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
        .fab-container {
    position: fixed;
    bottom: 80px;
    right: 20px;
    z-index: 1000;
    transition: opacity 0.3s ease;
}

/* „Ç®„Éá„Ç£„Çø„ÉºÁ∑®ÈõÜ‰∏≠„ÅØFAB„ÇíËñÑ„Åè„Åô„Çã */
.editor-textarea:focus ~ .fab-container {
    opacity: 0.3;
}
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #7c5b53;
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fab:active {
            transform: scale(0.95);
        }
        
        /* „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢ */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #D9BF9F;
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }
        .welcome-header {
            background: #7c5b53;
            padding: 40px 20px;
            text-align: center;
            color: white;
        }
        .welcome-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .welcome-subtitle {
            font-size: 14px;
            color: #e7d0a9;
        }
        .welcome-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }
        .welcome-btn {
            padding: 18px;
            background: #7c5b53;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .welcome-recent-title {
            font-size: 18px;
            font-weight: bold;
            color: #7c5b53;
            margin-bottom: 15px;
        }
        .welcome-recent-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .welcome-recent-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .welcome-recent-icon {
            width: 50px;
            height: 50px;
            background: #f0e6d2;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        .welcome-recent-info {
            flex: 1;
            min-width: 0;
        }
        .welcome-recent-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .welcome-recent-date {
            font-size: 11px;
            color: #999;
        }
        .welcome-recent-stats {
            font-size: 11px;
            color: #666;
        }
        .welcome-recent-delete {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #999;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        /* „É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: flex-end;
            z-index: 3000;
            animation: fadeIn 0.2s;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            width: 100%;
            max-height: 90vh;
            background: white;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s;
        }
        .modal-header {
            background: linear-gradient(to right, #7c5b53, #a0795f);
            color: white;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        .modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-btn-primary {
            background: #7c5b53;
            color: white;
        }
        .modal-btn-secondary {
            background: #e0e0e0;
            color: #666;
        }
        
        /* „É°„Éã„É•„Éº„É¢„Éº„ÉÄ„É´ */
        .menu-modal-content {
    max-height: 80vh;
}
.menu-list {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    max-height: calc(80vh - 80px);
    -webkit-overflow-scrolling: touch;
}
        .menu-item {
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
        }
        .menu-item:active {
            background: #f5f5f5;
        }
        .menu-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }
        
        /* Áµ±Ë®àË°®Á§∫ */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #7c5b53 0%, #a0795f 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-label {
            font-size: 11px;
            color: #e7d0a9;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-unit {
            font-size: 12px;
            color: #e7d0a9;
        }
        
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4a88b;
            border-radius: 2px;
        }
        
        /* „Çª„Éº„Éï„Ç®„É™„Ç¢ÂØæÂøú */
        @supports (padding: max(0px)) {
            .app-container {
                padding-top: max(0px, env(safe-area-inset-top));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢ -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-header">
            <div class="welcome-title">SceneÔºäWriter</div>
            <div class="welcome-subtitle">„É¢„Éê„Ç§„É´Áâà„Ç∑„Éä„É™„Ç™„Ç®„Éá„Ç£„Çø„Éº</div>
        </div>
        <div class="welcome-body">
            <div class="welcome-actions">
                <button class="welcome-btn" onclick="app.createNewProject()">üìù Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà</button>
                <button class="welcome-btn" onclick="app.loadProject()">üìÇ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÄ</button>
            </div>
            <div class="welcome-recent-title">ÊúÄËøë„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà</div>
            <div class="welcome-recent-list" id="recentProjectsList"></div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™ -->
    <div id="mainApp" class="app-container" style="display: none;">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="header">
            <div class="header-top">
                <div class="header-title">Scene*Writer</div>
                <div class="header-actions">
                    <button class="header-btn" onclick="app.showMenu()">‚ò∞</button>
                </div>
            </div>
            <div class="header-stats">
    <div class="header-stat-item">
        <span>üìù</span>
        <span id="headerTotalCharCount">0</span>ÊñáÂ≠ó
    </div>
    <div class="header-stat-item">
        <span>‚è±Ô∏è</span>
        <span id="headerEstimatedDuration">0</span>ÂàÜ
    </div>
    <div class="header-stat-item" id="saveStatus">
        <span>üíæ</span>
        <span>Ëá™Âãï‰øùÂ≠ò</span>
    </div>
</div>
        </div>

        <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="app.switchTab(0)">‚úèÔ∏è Á∑®ÈõÜ</button>
            <button class="tab-btn" onclick="app.switchTab(1)">üìã „Ç∑„Éº„É≥</button>
            <button class="tab-btn" onclick="app.switchTab(2)">üìù „Éó„É≠„Ç∏„Çß„ÇØ„Éà</button>
        </div>

        <!-- „Çø„Éñ1: „Ç®„Éá„Ç£„Çø„Éº -->
        <div class="tab-content active" id="tab-0">
            <div class="editor-container">
                <div class="editor-toolbar">
                    <div class="editor-toolbar-row">
                        <div class="char-count">
                            <span id="currentSceneName">Scene-01</span> | 
                            <span id="editorCharCount">0</span>ÊñáÂ≠ó
                        </div>
                    </div>
                    <div class="char-button-panel" id="charButtonPanel"></div>
                    <div class="tool-button-panel">
                        <button class="tool-button-mini tool-mini-green" onclick="app.insertToGaki()">„ÉàÊõ∏„Åç</button>
                        <button class="tool-button-mini tool-mini-green" onclick="app.insertLocation()">ÁèæÂú®Âú∞</button>
                        <button class="tool-button-mini tool-mini-brown" onclick="app.openSoundEffect()">ÂäπÊûúÈü≥</button>
                        <button class="tool-button-mini tool-mini-brown" onclick="app.openBGM()">BGM</button>
                        <button class="tool-button-mini tool-mini-brown" onclick="app.openAmbient()">Áí∞Â¢ÉÈü≥</button>
                    </div>
                    <div class="tool-button-panel" style="border-top: none; padding-top: 0;">
                        <button class="tool-button-mini tool-mini-pink" onclick="app.openMoanGenerator()">üíï Âñò„ÅéÂ£∞</button>
                        <button class="tool-button-mini tool-mini-red" onclick="app.openAdultSound()">üîû ÂäπÊûúÈü≥</button>
                        <button class="tool-button-mini tool-mini-beige" onclick="app.openCreativeSlot()">üé∞ „Çπ„É≠„ÉÉ„Éà</button>
<button class="tool-button-mini tool-mini-brown" onclick="app.openReplace()">üîÑ ÁΩÆÊèõ</button>
<button class="tool-button-mini tool-mini-brown" onclick="app.openDialogueNumbers()">üî¢ ÈÄ£Áï™</button>
                    </div>
                </div>
                <textarea class="editor-textarea" id="contentEditor" placeholder="„Åì„Åì„Å´„Ç∑„Éä„É™„Ç™„ÇíÂÖ•Âäõ..."></textarea>
            </div>
        </div>

        <!-- „Çø„Éñ2: „Ç∑„Éº„É≥ÈÅ∏Êäû -->
        <div class="tab-content" id="tab-1">
            <div class="scene-list">
                <div class="scene-controls">
                    <div class="scene-count-group">
                        <span class="scene-count-label">„Ç∑„Éº„É≥Êï∞:</span>
                        <select class="scene-count-select" id="sectionCount">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                        </select>
                        <button class="scene-apply-btn" onclick="app.applySectionCount()">ÈÅ©Áî®</button>
                    </div>
                    <div class="tool-section" style="margin-top: 15px;">
                        <div class="tool-section-title">„Ç∑„Éº„É≥Âà•„ÅÇ„Çâ„Åô„Åò</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                            ÁèæÂú®„ÅÆ„Ç∑„Éº„É≥: <span id="currentSceneNameInTab" style="font-weight: bold; color: #7c5b53;">Scene-01</span>
                        </div>
                        <textarea class="memo-textarea" id="synopsisEditorTab" placeholder="ÁèæÂú®„ÅÆ„Ç∑„Éº„É≥„ÅÆ„ÅÇ„Çâ„Åô„Åò„ÇíÂÖ•Âäõ..." style="min-height: 100px;"></textarea>
                    </div>
                </div>
                <div id="sceneList"></div>
            </div>
        </div>

        <!-- „Çø„Éñ3: „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†± -->
        <div class="tab-content" id="tab-2">
            <div class="tools-container">
                <div class="tool-section">
                    <div class="tool-section-title">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±</div>
                    <div style="margin-bottom: 15px;">
                        <div class="project-label">‰ΩúÂìÅ„Çø„Ç§„Éà„É´</div>
                        <input type="text" class="project-input" id="projectTitleTab" placeholder="„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div class="project-label">ÂÖ®‰Ωì„ÅÇ„Çâ„Åô„Åò</div>
                        <textarea class="project-textarea" id="globalSynopsisTab" placeholder="„ÅÇ„Çâ„Åô„Åò„ÇíÂÖ•Âäõ" style="min-height: 100px;"></textarea>
                    </div>
                </div>

                <div class="tool-section">
                    <div class="tool-section-title">„Ç≠„É£„É©„ÇØ„Çø„ÉºË®≠ÂÆö</div>
                    <button class="tool-btn tool-btn-brown" onclick="app.openCharacterManager()" style="width: 100%; margin-bottom: 10px;">
                        üë• „Ç≠„É£„É©„ÇØ„Çø„ÉºÁÆ°ÁêÜ
                    </button>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="useQuoteCheckboxTab">
                            <span>„Äå„ÄçÂΩ¢Âºè„ÅßÊåøÂÖ•</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="useColonCheckboxTab" checked>
                            <span>ÔºöÂΩ¢Âºè„ÅßÊåøÂÖ•</span>
                        </label>
                    </div>
                </div>
                
                <div class="tool-section">
                    <div class="tool-section-title">„É°„É¢</div>
                    <textarea class="memo-textarea" id="memoEditorTab" placeholder="Ëá™Áî±„Å´„É°„É¢„ÇíÂÖ•Âäõ..." style="min-height: 200px;"></textarea>
                </div>
            </div>
        </div>

       
    </div>

    <!-- „É°„Éã„É•„Éº„É¢„Éº„ÉÄ„É´ -->
    <div id="menuModal" class="modal">
        <div class="modal-content menu-modal-content">
            <div class="modal-header">
                <div class="modal-title">„É°„Éã„É•„Éº</div>
                <button class="modal-close" onclick="app.hideMenu()">√ó</button>
            </div>
            <div class="menu-list">
<div class="menu-item" onclick="app.backToWelcome()">
    <span class="menu-icon">üè†</span>
    <span>„Éõ„Éº„É†</span>
</div>
<div class="menu-item" onclick="window.open('help.html', '_blank')">
    <span class="menu-icon">üí°</span>
    <span>‰Ωø„ÅÑÊñπ</span>
</div>
                <div class="menu-item" onclick="app.createNewProject()">
                    <span class="menu-icon">üìù</span>

                    <span>Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà</span>
                </div>
                <div class="menu-item" onclick="app.loadProject()">
                    <span class="menu-icon">üìÇ</span>
                    <span>„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÄ</span>
                </div>
                <div class="menu-item" onclick="app.saveProject()">
                    <span class="menu-icon">üíæ</span>
                    <span>‰∏äÊõ∏„Åç‰øùÂ≠ò</span>
                </div>
                <div class="menu-item" onclick="app.exportProject()">
                    <span class="menu-icon">üì§</span>
                    <span>„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí„Ç≥„Éî„Éº</span>
                </div>
                <div class="menu-item" onclick="app.exportTxt()">
                    <span class="menu-icon">üìÑ</span>
                    <span>TXT„Çí„Ç≥„Éî„Éº</span>
                </div>
                <div class="menu-item" onclick="app.showAnalysis()">
    <span class="menu-icon">üìä</span>
    <span>ÂàÜÊûê„ÉÑ„Éº„É´</span>
</div>
                <div class="menu-item" onclick="app.toggleProjectPanel()">
                    <span class="menu-icon">‚ÑπÔ∏è</span>
                    <span>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±</span>
                </div>
                            </div>
        </div>
    </div>

    <script>
// Scene*Writer Mobile - ÂÆåÂÖ®ÁâàJavaScript
// „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁâà„ÅÆÂÖ®Ê©üËÉΩ„ÇíÂê´„ÇÄ

const app = {
    currentProject: null,
    cuts: [],
    currentCut: 0,
    characters: [],
    
    init() {
        const select = document.getElementById('sectionCount');
        select.innerHTML = '';
        for (let i = 1; i <= 300; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === 10) option.selected = true;
            select.appendChild(option);
        }
        
        this.setupEventListeners();
        this.startClock();
        this.updateRecentProjects();
    },
    
    setupEventListeners() {
        document.getElementById('contentEditor').addEventListener('input', () => {
            this.updateCharCount();
        });
        
        const syncProjectTitle = () => {
            const value = document.getElementById('projectTitleTab').value;
            this._projectTitle = value;
        };
        
        const syncGlobalSynopsis = () => {
            const value = document.getElementById('globalSynopsisTab').value;
            this._globalSynopsis = value;
        };
        
        const syncSynopsis = () => {
            if (this.cuts[this.currentCut]) {
                this.cuts[this.currentCut].synopsis = document.getElementById('synopsisEditorTab').value;
            }
        };
        
        const syncMemo = () => {
            if (this.currentProject) {
                localStorage.setItem(`memo_${this.currentProject}`, document.getElementById('memoEditorTab').value);
            }
        };
        
        document.getElementById('projectTitleTab').addEventListener('input', syncProjectTitle);
        document.getElementById('globalSynopsisTab').addEventListener('input', syncGlobalSynopsis);
        document.getElementById('synopsisEditorTab').addEventListener('input', syncSynopsis);
        document.getElementById('memoEditorTab').addEventListener('input', syncMemo);
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    },
    
    startClock() {
        setInterval(() => {
            let totalChars = 0;
            this.cuts.forEach((cut, index) => {
                if (index === this.currentCut) {
                    const editor = document.getElementById('contentEditor');
                    totalChars += editor ? editor.value.length : 0;
                } else {
                    totalChars += cut.content ? cut.content.length : 0;
                }
            });
            
            const minutes = Math.floor(totalChars / 240);
            const headerTotalCharCount = document.getElementById('headerTotalCharCount');
            const headerEstimatedDuration = document.getElementById('headerEstimatedDuration');
            
            if (headerTotalCharCount) headerTotalCharCount.textContent = totalChars.toLocaleString();
            if (headerEstimatedDuration) headerEstimatedDuration.textContent = minutes;
        }, 1000);
    },
    
    switchTab(index) {
        document.querySelectorAll('.tab-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i === index);
        });
        document.querySelectorAll('.tab-content').forEach((content, i) => {
            content.classList.toggle('active', i === index);
        });
        
        if (index === 1) {
            this.updateSceneList();
            if (this.cuts[this.currentCut]) {
                document.getElementById('synopsisEditorTab').value = this.cuts[this.currentCut].synopsis || '';
                const sceneNameInTab = document.getElementById('currentSceneNameInTab');
                if (sceneNameInTab) {
                    sceneNameInTab.textContent = this.cuts[this.currentCut].name;
                }
            }
        }
        
        if (index === 2) {
            document.getElementById('projectTitleTab').value = this._projectTitle || '';
            document.getElementById('globalSynopsisTab').value = this._globalSynopsis || '';
        }
    },
    
   showMenu() {
    // Êó¢„Å´Èñã„ÅÑ„Å¶„ÅÑ„Çã„É¢„Éº„ÉÄ„É´„Çí„Åô„Åπ„Å¶Èñâ„Åò„ÇãÔºà„É°„Éã„É•„Éº‰ª•Â§ñÔºâ
    document.querySelectorAll('.modal').forEach(modal => {
        if (modal.id !== 'menuModal') {
            modal.remove();
        }
    });
    
    const menuModal = document.getElementById('menuModal');
    if (menuModal) {
        // „É°„Éã„É•„Éº„É¢„Éº„ÉÄ„É´„ÅåÊó¢„Å´active„Å´„Å™„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰∏ÄÊó¶„É™„Çª„ÉÉ„Éà
        menuModal.classList.remove('active');
        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶active„Å´„Åô„ÇãÔºàÂº∑Âà∂ÁöÑ„Å´ÂÜçÊèèÁîªÔºâ
        setTimeout(() => {
            menuModal.classList.add('active');
        }, 10);
    } else {
        console.error('„É°„Éã„É•„Éº„É¢„Éº„ÉÄ„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        alert('„É°„Éã„É•„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
},


    
    toggleProjectPanel() {
        const panel = document.getElementById('projectPanel');
        if (panel) panel.classList.toggle('collapsed');
        this.hideMenu();
    },
    
    updateRecentProjects() {
        const list = document.getElementById('recentProjectsList');
        const projects = this.getRecentProjects();
        
        list.innerHTML = '';
        projects.forEach(project => {
            const item = document.createElement('div');
            item.className = 'welcome-recent-item';
            item.innerHTML = `
                <div class="welcome-recent-icon">üìù</div>
                <div class="welcome-recent-info">
                    <div class="welcome-recent-name">${project.name}</div>
                    <div class="welcome-recent-date">${new Date(project.lastModified).toLocaleString('ja-JP')}</div>
                    <div class="welcome-recent-stats">${project.cuts}„Ç∑„Éº„É≥ / ${project.characters}ÊñáÂ≠ó</div>
                </div>
                <button class="welcome-recent-delete" onclick="app.deleteProject('${project.name}'); event.stopPropagation();">√ó</button>
            `;
            item.onclick = () => this.loadProject(project.name);
            list.appendChild(item);
        });
    },
    
    getRecentProjects() {
        const stored = localStorage.getItem('voiceWriterProjects');
        return stored ? JSON.parse(stored) : [];
    },
    
    saveProjectList() {
        const projects = this.getRecentProjects();
        const existing = projects.findIndex(p => p.name === this.currentProject);
        
        const projectData = {
            name: this.currentProject,
            lastModified: new Date().toISOString(),
            cuts: this.cuts.length,
            characters: this.calculateTotalCharacters(this.currentProject)
        };
        
        if (existing >= 0) {
            projects[existing] = projectData;
        } else {
            projects.unshift(projectData);
        }
        
        localStorage.setItem('voiceWriterProjects', JSON.stringify(projects.slice(0, 20)));
    },
    
    calculateTotalCharacters(projectName) {
        const data = localStorage.getItem(`project_${projectName}`);
        if (!data) return 0;
        
        const project = JSON.parse(data);
        return project.cuts.reduce((sum, cut) => sum + (cut.content ? cut.content.length : 0), 0);
    },
    
    createNewProject() {
        const name = prompt('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', `„Éó„É≠„Ç∏„Çß„ÇØ„Éà_${Date.now()}`);
        if (!name) return;
        
        this._projectTitle = '';
        this._globalSynopsis = '';
        
        document.getElementById('projectTitleTab').value = '';
        document.getElementById('globalSynopsisTab').value = '';
        document.getElementById('memoEditorTab').value = '';
        document.getElementById('contentEditor').value = '';
        document.getElementById('synopsisEditorTab').value = '';
        
        this.currentProject = name;
        this.cuts = [];
        for (let i = 0; i < 10; i++) {
            this.cuts.push({
                name: `Scene-${String(i + 1).padStart(2, '0')}`,
                content: '',
                synopsis: '',
                targetMinutes: 0
            });
        }
        this.characters = [];
        this.currentCut = -1;
        
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        
        setTimeout(() => {
        this.loadCut(0);
        this.updateSceneList();
        this.updateCharacterButtons();
        this.saveProject();
        
        // „É°„Éã„É•„Éº„É¢„Éº„ÉÄ„É´„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
        const menuModal = document.getElementById('menuModal');
        if (menuModal) {
            menuModal.classList.remove('active');
        }
    }, 0);
    
    this.hideMenu();
},
    loadProject(name) {
        if (!name) {
            this.showLoadProjectModal();
            return;
        }
        
        const data = localStorage.getItem(`project_${name}`);
        if (!data) {
            alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            return;
        }
        
        this.loadProjectFromData(data, name);
    },
    
    showLoadProjectModal() {
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content" style="max-height: 85vh;">
                <div class="modal-header">
                    <div class="modal-title">üìÇ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÄ</div>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                </div>
                <div class="modal-body" style="overflow-y: auto;">
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 8px; color: #7c5b53;">‰øùÂ≠ò„Åó„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ</div>
                        <textarea id="pasteProjectData" 
                                  style="width: 100%; height: 300px; padding: 10px; border: 1px solid #c4a88b; border-radius: 8px; font-family: monospace; font-size: 12px; background: white; resize: vertical;" 
                                  placeholder="„É°„É¢„Ç¢„Éó„É™„Å´‰øùÂ≠ò„Åó„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„ÇøÔºà.vwpÔºâ„ÅÆÂÜÖÂÆπ„Çí&#10;„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ...&#10;&#10;„ÄêË≤º„Çä‰ªò„ÅëÊñπÊ≥ï„Äë&#10;1. „É°„É¢„Ç¢„Éó„É™„Åß‰øùÂ≠ò„Åó„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈñã„Åè&#10;2. ÂÖ®ÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº&#10;3. „Åì„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´Èï∑Êäº„Åó„Åß„Éö„Éº„Çπ„Éà"></textarea>
                    </div>
                    
                    <div style="background: #f0e6d2; padding: 12px; border-radius: 8px; font-size: 12px; color: #7c5b53; line-height: 1.6;">
                        <div style="font-weight: bold; margin-bottom: 5px;">üí° ‰Ωø„ÅÑÊñπ</div>
                        <div>‚Ä¢ „É°„É¢„Ç¢„Éó„É™„Å´‰øùÂ≠ò„Åó„Åü .vwp „Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„Çí„Ç≥„Éî„Éº</div>
                        <div>‚Ä¢ ‰∏ä„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´Ë≤º„Çä‰ªò„Åë</div>
                        <div>‚Ä¢ „ÄåË™≠„ÅøËæº„ÇÄ„Äç„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="app.loadFromPaste()">Ë™≠„ÅøËæº„ÇÄ</button>
                    <button class="modal-btn modal-btn-secondary" onclick="this.closest('.modal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        this.hideMenu();
    },
    
    loadFromPaste() {
    const textarea = document.getElementById('pasteProjectData');
    const pastedData = textarea.value.trim();
    
    if (!pastedData) {
        alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
        return;
    }
    
    try {
        const project = JSON.parse(pastedData);
        
        const projectName = prompt('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', `Ë™≠„ÅøËæº„Åø_${Date.now()}`);
        if (!projectName) {
            return;
        }
        
        localStorage.setItem(`project_${projectName}`, pastedData);
        
        // „Åô„Åπ„Å¶„ÅÆ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.querySelectorAll('.modal').forEach(modal => {
            modal.remove();
        });
        
        this.loadProjectFromData(pastedData, projectName);
        
    } catch (error) {
        alert(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Ç®„É©„Éº: ${error.message}\n\nÊ≠£„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„ÇøÔºà.vwpÂΩ¢ÂºèÔºâ„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
    }
},

    
    
    loadProjectFromData(data, name) {
    try {
        const project = JSON.parse(data);
        
        const cuts = project.cuts || [];
        cuts.forEach(cut => {
            if (cut.name && cut.name.startsWith('Cut-')) {
                cut.name = cut.name.replace('Cut-', 'Scene-');
            }
        });
        
        document.getElementById('contentEditor').value = '';
        
        this.currentProject = name;
        this.cuts = cuts;
        this.characters = project.characters || [];
        this.currentCut = -1;
        
        this._projectTitle = project.title || '';
        this._globalSynopsis = project.globalSynopsis || '';
        
        document.getElementById('projectTitleTab').value = this._projectTitle;
        document.getElementById('globalSynopsisTab').value = this._globalSynopsis;
        
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        
        setTimeout(() => {
            this.loadCut(0);
            this.updateSceneList();
            this.updateCharacterButtons();
            
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.id !== 'menuModal') {
                    modal.remove();
                } else {
                    modal.classList.remove('active');
                }
            });
        }, 0);
        
        alert(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ`);
        
    } catch (error) {
        alert(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n„Ç®„É©„Éº: ${error.message}`);
    }
},

    
    saveProject() {
        if (!this.currentProject) return;
        
        this.saveCutContent();
        
        const project = {
            cuts: this.cuts,
            characters: this.characters,
            title: this._projectTitle || '',
            globalSynopsis: this._globalSynopsis || '',
            lastModified: new Date().toISOString()
        };
        
        localStorage.setItem(`project_${this.currentProject}`, JSON.stringify(project));
        this.saveProjectList();
        
        alert(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${this.currentProject}„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ`);
        this.hideMenu();
    },
    
    deleteProject(name) {
        if (!confirm(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
        
        localStorage.removeItem(`project_${name}`);
        const projects = this.getRecentProjects().filter(p => p.name !== name);
        localStorage.setItem('voiceWriterProjects', JSON.stringify(projects));
        this.updateRecentProjects();
    },
    
    exportProject() {
        if (!this.currentProject) {
            alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÈñã„Åã„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            return;
        }
        
        this.saveCutContent();
        const data = localStorage.getItem(`project_${this.currentProject}`);
        if (!data) return;
        
        this.downloadFile(data, `${this.currentProject}.vwp`, 'application/json');
        this.hideMenu();
    },
    
    exportTxt() {
        if (!this.currentProject) {
            alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÈñã„Åã„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            return;
        }
        
        let text = `„Éó„É≠„Ç∏„Çß„ÇØ„Éà: ${this.currentProject}\n`;
        text += `‰ΩúÊàêÊó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}\n`;
        text += '='.repeat(50) + '\n\n';
        
        this.cuts.forEach(cut => {
            text += `„Äê${cut.name}„Äë\n`;
            if (cut.synopsis) {
                text += `„ÅÇ„Çâ„Åô„Åò: ${cut.synopsis}\n`;
            }
            text += `${cut.content}\n`;
            text += '-'.repeat(50) + '\n\n';
        });
        
        this.downloadFile(text, `${this.currentProject}.txt`, 'text/plain');
        this.hideMenu();
    },
    
    backToWelcome() {
    if (this.currentProject) {
        this.saveCutContent();
        const project = {
            cuts: this.cuts,
            characters: this.characters,
            title: this._projectTitle || '',
            globalSynopsis: this._globalSynopsis || '',
            lastModified: new Date().toISOString()
        };
        localStorage.setItem(`project_${this.currentProject}`, JSON.stringify(project));
        this.saveProjectList();
    }
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'flex';
    this.updateRecentProjects();
    
    // „É°„Éã„É•„Éº„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    const menuModal = document.getElementById('menuModal');
    if (menuModal) {
        menuModal.classList.remove('active');
    }
},

hideMenu() {
    const menuModal = document.getElementById('menuModal');
    if (menuModal) {
        menuModal.classList.remove('active');
    }
},

    applySectionCount() {
        const count = parseInt(document.getElementById('sectionCount').value);
        const currentCount = this.cuts.length;
        
        if (count > currentCount) {
            for (let i = currentCount; i < count; i++) {
                this.cuts.push({
                    name: `Scene-${String(i + 1).padStart(2, '0')}`,
                    content: '',
                    synopsis: '',
                    targetMinutes: 0
                });
            }
        } else if (count < currentCount) {
            if (!confirm(`„Ç∑„Éº„É≥Êï∞„ÇíÊ∏õ„Çâ„Åô„Å®„ÄÅ${currentCount - count}ÂÄã„ÅÆ„Ç∑„Éº„É≥„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü`)) {
                return;
            }
            this.cuts = this.cuts.slice(0, count);
            if (this.currentCut >= count) {
                this.currentCut = count - 1;
            }
        }
        
        this.updateSceneList();
        this.loadCut(this.currentCut);
    },
    
    updateSceneList() {
        const list = document.getElementById('sceneList');
        list.innerHTML = '';
        
        this.cuts.forEach((cut, index) => {
            const item = document.createElement('div');
            item.className = 'scene-item';
            if (index === this.currentCut) {
                item.classList.add('active');
            }
            
            const chars = cut.content ? cut.content.length : 0;
            const minutes = Math.floor(chars / 240);
            
            item.innerHTML = `
                <div class="scene-name">${cut.name}</div>
                <div class="scene-stats">${chars}ÊñáÂ≠ó / ${minutes}ÂàÜ</div>
            `;
            item.onclick = () => {
                this.loadCut(index);
                this.switchTab(0);
            };
            
            list.appendChild(item);
        });
    },
    
    loadCut(index) {
        if (this.currentCut !== index) {
            this.saveCutContent();
        }
        
        this.currentCut = index;
        const cut = this.cuts[index];
        
        document.getElementById('contentEditor').value = cut.content || '';
        document.getElementById('synopsisEditorTab').value = cut.synopsis || '';
        document.getElementById('currentSceneName').textContent = cut.name;
        
        const sceneNameInTab = document.getElementById('currentSceneNameInTab');
        if (sceneNameInTab) {
            sceneNameInTab.textContent = cut.name;
        }
        
        this.updateSceneList();
        this.updateCharCount();
    },
    
    saveCutContent() {
        if (this.cuts[this.currentCut]) {
            this.cuts[this.currentCut].content = document.getElementById('contentEditor').value;
        }
    },
    
    updateCharCount() {
    const content = document.getElementById('contentEditor').value;
    document.getElementById('editorCharCount').textContent = content.length;
    
    this.saveCutContent();
    
    // Ëá™Âãï‰øùÂ≠ò„Çø„Ç§„Éû„ÉºË®≠ÂÆö
    if (this.autoSaveTimer) {
        clearTimeout(this.autoSaveTimer);
    }
    
    this.autoSaveTimer = setTimeout(() => {
        this.autoSave();
    }, 2000); // 2ÁßíÂæå„Å´Ëá™Âãï‰øùÂ≠ò
    
    const totalChars = this.cuts.reduce((sum, cut) => sum + (cut.content ? cut.content.length : 0), 0);
    const headerTotalCharCount = document.getElementById('headerTotalCharCount');
    const headerEstimatedDuration = document.getElementById('headerEstimatedDuration');
    
    if (headerTotalCharCount) headerTotalCharCount.textContent = totalChars.toLocaleString();
    if (headerEstimatedDuration) headerEstimatedDuration.textContent = Math.floor(totalChars / 240);
},
    
    openCharacterManager() {
        const name = prompt('„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
        if (name && !this.characters.includes(name)) {
            this.characters.push(name);
            this.updateCharacterButtons();
        }
    },
autoSave() {
    if (!this.currentProject) return;
    
    this.saveCutContent();
    
    const project = {
        cuts: this.cuts,
        characters: this.characters,
        title: this._projectTitle || '',
        globalSynopsis: this._globalSynopsis || '',
        lastModified: new Date().toISOString()
    };
    
    localStorage.setItem(`project_${this.currentProject}`, JSON.stringify(project));
    this.saveProjectList();
    
    // ‰øùÂ≠ò„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
    const saveStatus = document.getElementById('saveStatus');
    if (saveStatus) {
        saveStatus.innerHTML = '<span>üíæ</span><span>‰øùÂ≠òÊ∏à„Åø</span>';
        setTimeout(() => {
            if (saveStatus) {
                saveStatus.innerHTML = '<span>üíæ</span><span>ÔºíÁßí„Åä„Åç„Å´Ëá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åôüß∏</span>';
            }
        }, 1000);
    }
},

    
    updateCharacterButtons() {
        const panel = document.getElementById('charButtonPanel');
        panel.innerHTML = '';
        
        this.characters.forEach(char => {
            const btn = document.createElement('button');
            btn.className = 'char-button';
            btn.textContent = char;
            btn.onclick = () => this.insertCharacter(char);
            panel.appendChild(btn);
        });
        
        const specialChars = ['‚Ä¶', '„Å£', '„ÉÉ', '‚ô°', '„Äú', '„Éº'];
        specialChars.forEach(char => {
            const btn = document.createElement('button');
            btn.className = 'char-button';
            btn.textContent = char;
            btn.onclick = () => this.insertText(char);
            panel.appendChild(btn);
        });
    },
    
    insertCharacter(name) {
        const useQuote = document.getElementById('useQuoteCheckboxTab')?.checked || false;
        const useColon = document.getElementById('useColonCheckboxTab')?.checked || true;
        
        let text = '';
        if (useColon) {
            text = `${name}Ôºö`;
        } else if (useQuote) {
            text = `${name}„Äå„Äç`;
        } else {
            text = name;
        }
        
        this.insertText(text);
    },
    
    insertText(text) {
        const editor = document.getElementById('contentEditor');
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const content = editor.value;
        
        editor.value = content.substring(0, start) + text + content.substring(end);
        editor.selectionStart = editor.selectionEnd = start + text.length;
        
        if (text.includes('„Äå„Äç')) {
            editor.selectionStart = editor.selectionEnd = start + text.length - 1;
        }
        
        editor.focus();
        this.saveCutContent();
        this.updateCharCount();
    },
    
    insertToGaki() {
        this.insertText('// ');
    },
    
    insertLocation() {
        this.insertText('„Äá ');
    },
    
    openSoundEffect() {
        this.insertText('‚òÜÂäπÊûúÈü≥//');
    },
    
    openBGM() {
        this.insertText('‚òÜBGM//');
    },
    
    openAmbient() {
        this.insertText('‚òÜÁí∞Â¢ÉÈü≥//');
    },
    
 openMoanGenerator() {
    this.showMoanGeneratorModal();
},

showMoanGeneratorModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header" style="background: linear-gradient(to right, #c85a8b, #d87aa0);">
                <div class="modal-title">üíï Âñò„ÅéÂ£∞ÁîüÊàê</div>
                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #7c5b53;">Âñò„ÅéÂ£∞„Çø„Ç§„Éó</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="moanType" value="normal" checked>
                            <span>ÈÄöÂ∏∏</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="moanType" value="a-only">
                            <span>„Äå„ÅÇ„Äç„ÅÆ„Åø</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="moanType" value="n-only">
                            <span>„Äå„Çì„Äç„ÅÆ„Åø</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #7c5b53;">
                        Èï∑„Åï: <span id="moanLength">20</span>Ë™û
                    </div>
                    <input type="range" id="moanLengthSlider" min="5" max="50" value="20" 
                           style="width: 100%;"
                           oninput="document.getElementById('moanLength').textContent = this.value">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #7c5b53;">„Ç™„Éó„Ç∑„Éß„É≥</div>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" id="useDakuon">
                        <span>ÊøÅÈü≥„Çí‰Ωø„ÅÜ</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" id="useHeart" checked>
                        <span>„Éè„Éº„Éà(‚ô°)„Çí‰ªò„Åë„Çã</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="useDialogue">
                        <span>„Çª„É™„Éï„ÇíÊ∑∑„Åú„Çã</span>
                    </label>
                </div>
                
                <div id="dialogueOptions" style="margin-bottom: 15px; display: none;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #7c5b53;">„Çª„É™„Éï„ÅÆÁ®ÆÈ°û</div>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" class="dialogue-type" value="suki">
                        <span>„Åô„ÅçÁ≥ª</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" class="dialogue-type" value="onegai">
                        <span>„ÅäÈ°ò„ÅÑÁ≥ª</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" class="dialogue-type" value="yamete">
                        <span>„ÇÑ„ÇÅ„Å¶Á≥ª</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="dialogue-type" value="kimochii">
                        <span>„Åç„ÇÇ„Å°„ÅÑ„ÅÑÁ≥ª</span>
                    </label>
                </div>
                
                <button onclick="app.generateMoan()" 
                        style="width: 100%; padding: 12px; background: #c85a8b; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; margin-bottom: 15px;">
                    ÁîüÊàê
                </button>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #7c5b53;">ÁîüÊàêÁµêÊûú</div>
                    <div id="moanResult" style="background: #f9f9f9; padding: 15px; border-radius: 8px; min-height: 100px; font-family: 'MS Gothic', monospace; font-size: 14px; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word;">
                        „Åì„Åì„Å´ÁîüÊàê„Åï„Çå„ÅüÂñò„ÅéÂ£∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="app.insertGeneratedMoan()">ÊåøÂÖ•</button>
                <button class="modal-btn modal-btn-secondary" onclick="this.closest('.modal').remove()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.querySelector('#useDialogue').addEventListener('change', (e) => {
        modal.querySelector('#dialogueOptions').style.display = e.target.checked ? 'block' : 'none';
    });
},

generateMoan() {
    // ÊúÄÂæå„Å´Ë°®Á§∫„Åï„Çå„Åü„É¢„Éº„ÉÄ„É´Ôºà„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„É¢„Éº„ÉÄ„É´Ôºâ„ÇíÂèñÂæó
    const modals = document.querySelectorAll('.modal.active');
    const modal = modals[modals.length - 1];
    
    if (!modal) {
        alert('„É¢„Éº„ÉÄ„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    const typeInput = modal.querySelector('input[name="moanType"]:checked');
    if (!typeInput) {
        alert('Âñò„ÅéÂ£∞„Çø„Ç§„Éó„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        return;
    }
    
    const type = typeInput.value;
    const lengthSlider = modal.querySelector('#moanLengthSlider');
    const length = lengthSlider ? parseInt(lengthSlider.value) : 20;
    const useDakuon = modal.querySelector('#useDakuon')?.checked || false;
    const useHeart = modal.querySelector('#useHeart')?.checked || false;
    const useDialogue = modal.querySelector('#useDialogue')?.checked || false;

    const normalMoans = ['„ÅÇ„Å£', '„Çì„Å£', '„ÅØ„ÅÅ„Å£', '„Åµ„ÅÅ„Å£', '„Å≤„ÇÉ„Å£', '„ÅÇ„ÅÅ„Å£', '„Çì„Çì„Å£', '„ÅØ„ÅÅ„ÅÅ„Å£', '„Åµ„ÅÖ„Å£', '„Å≤„ÅÖ„Å£', 
                         '„ÅÇ„Çì„Å£', '„Çì„ÅÇ„Å£', '„ÅØ„ÅÅ„Çì„Å£', '„Åµ„ÅÅ„ÅÅ„Å£', '„ÇÑ„Å£', '„ÅÑ„Å£', '„ÅÜ„Å£', '„Åà„Å£', '„Åä„Å£', '„Åç„ÇÉ„Å£',
                         '„Å≤„Å£', '„Åµ„Å£', '„Å∏„Å£', '„Åª„Å£', '„Åè„ÅÖ„Å£', '„ÅÇ„ÅØ„Å£', '„Çì„ÅØ„Å£', '„ÅØ„ÅÜ„Å£', '„Åµ„ÅÖ„Çì„Å£', '„Å≤„ÅÉ„Å£'];
    const aMoans = ['„ÅÇ„Å£', '„ÅÇ„ÅÅ„Å£', '„ÅÇ„ÅÇ„ÅÇ„Å£', '„ÅÇ„ÅÇ„ÅÅ„Å£', '„ÅÇ„Çì„Å£', '„ÅÇ„ÅØ„Å£', '„ÅÇ„ÅÖ„Å£', '„ÅÇ„ÅÅ„ÅÅ„Å£'];
    const nMoans = ['„Çì„Å£', '„Çì„Çì„Å£', '„Çì„ÅÖ„Å£', '„Çì„ÅÇ„ÅÇ„Å£', '„Çì„Çì„Çì„Å£', '„Çì„ÅØ„Å£', '„Çì„ÅÅ„Å£', '„Çì„Åµ„Å£'];
    const dakuonMoans = ['„Çì„Çõ„Å£', '„Çì„Çõ„Çì„Çõ„Å£', '„Çì„Çõ„ÅÇ„Å£', '„Çì„Çõ„ÅÖ„Å£', '„Çì„Å£„Çõ', '„Çì„Çì„Å£„Çõ', '„Åä„Çõ„Å£', '„Çì„Çõ„Åä„Çõ„Å£', '„ÅÇ„Çõ', '„ÅÇ„Çõ„ÅÇ„Çõ„Å£'];
    
    const dialogues = {
        suki: ['Â•Ω„Åç', 'Â§ßÂ•Ω„Åç', '„Åô„Åç', '„Å†„ÅÑ„Åô„Åç'],
        onegai: ['„ÅäÈ°ò„ÅÑ', '„ÇÇ„Å£„Å®', '„Åä„Å≠„Åå', '„Åä„Å≠„ÄÅ„Åå'],
        yamete: ['„ÇÑ„ÇÅ„Å¶', '„ÅÑ„ÇÑ', '„ÇÑ„Å†', '„Å†„ÇÅ', '„Çâ„ÇÅ', '„Å†„ÇÅ„Åá', '„Çâ„ÇÅ„Åá'],
        kimochii: ['Ê∞óÊåÅ„Å°„ÅÑ„ÅÑ', '„Åç„ÇÇ„Å°„ÅÑ„ÅÑ', '„ÅÑ„ÅÑ', '„Åç„ÇÇ„Å°„ÅÑ', '„Ç§„ÉÉ', '„Ç§„ÇØ„ÉÉ', '„Ç§„ÇØ', '„Ç§„ÇØ‚Ä¶', '„Ç§„ÇØ„Ç§„ÇØ„Ç§„ÇØ„Ç§„ÇØ']
    };

    let moans = type === 'a-only' ? aMoans : type === 'n-only' ? nMoans : normalMoans;
    let result = [];

    let selectedDialogues = [];
    if (useDialogue) {
        modal.querySelectorAll('.dialogue-type:checked').forEach(checkbox => {
            selectedDialogues = selectedDialogues.concat(dialogues[checkbox.value] || []);
        });
    }

    for (let i = 0; i < length; i++) {
        if (useDialogue && selectedDialogues.length > 0 && Math.random() < 0.1) {
            const dialogue = selectedDialogues[Math.floor(Math.random() * selectedDialogues.length)];
            result.push(dialogue + (useHeart ? '‚ô°' : ''));
        } else {
            let moan;
            if (useDakuon && Math.random() < 0.3) {
                moan = dakuonMoans[Math.floor(Math.random() * dakuonMoans.length)];
            } else {
                moan = moans[Math.floor(Math.random() * moans.length)];
            }
            result.push(moan + (useHeart ? '‚ô°' : ''));
        }
    }

    const separator = type === 'normal' ? '‚Ä¶‚Ä¶' : '„ÄÄ';
    const generatedText = result.join(separator);
    
    const resultElem = modal.querySelector('#moanResult');
    if (resultElem) {
        resultElem.textContent = generatedText;
        this._generatedMoan = generatedText;
    } else {
        alert('ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
    }
},
insertGeneratedMoan() {
    if (this._generatedMoan) {
        this.insertText(this._generatedMoan);
        document.querySelector('.modal').remove();
    } else {
        alert('ÂÖà„Å´Âñò„ÅéÂ£∞„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    }
},

openAdultSound() {
    this.showAdultSoundModal();
},

showAdultSoundModal() {
    const soundButtons = [
        { category: '„Éî„Çπ„Éà„É≥', sounds: [
            { label: '„Éî„Çπ„Éà„É≥(„ÇÜ„Å£„Åè„Çä)' },
            { label: '„Éî„Çπ„Éà„É≥(ÊôÆÈÄö)' },
            { label: '„Éî„Çπ„Éà„É≥(ÊøÄ„Åó„ÅÑ)' }
        ]},
        { category: '„Éë„É≥„Éë„É≥', sounds: [
            { label: '„Éë„É≥„Éë„É≥(„ÇÜ„Å£„Åè„Çä)' },
            { label: '„Éë„É≥„Éë„É≥(ÊôÆÈÄö)' },
            { label: '„Éë„É≥„Éë„É≥(ÊøÄ„Åó„ÅÑ)' }
        ]},
        { category: 'Êâã„Ç≥„Ç≠', sounds: [
            { label: 'Êâã„Ç≥„Ç≠(„ÇÜ„Å£„Åè„Çä)' },
            { label: 'Êâã„Ç≥„Ç≠(ÊôÆÈÄö)' },
            { label: 'Êâã„Ç≥„Ç≠(ÊøÄ„Åó„ÅÑ)' }
        ]},
        { category: 'ÊÑõÊí´', sounds: [
            { label: 'ÊÑõÊí´(„ÇÑ„Åï„Åó„ÅÑ)' },
            { label: 'ÊÑõÊí´(ÊøÄ„Åó„ÅÑ)' }
        ]},
        { category: 'ÊåøÂÖ•', sounds: [
            { label: 'ÊåøÂÖ•' }
        ]},
        { category: 'Â∞ÑÁ≤æ', sounds: [
            { label: 'Â∞ÑÁ≤æ(Â§ñ„Å´Â§ßÈáè)' },
            { label: 'Â∞ÑÁ≤æ(‰∏≠„Å´Â§ßÈáè)' },
            { label: 'Â∞ÑÁ≤æ(Â§ñ„Å´Â∞ëÈáè)' },
            { label: 'Â∞ÑÁ≤æ(‰∏≠„Å´Â∞ëÈáè)' }
        ]}
    ];

    let buttonsHtml = '';
    soundButtons.forEach(category => {
        buttonsHtml += `
            <div style="margin-bottom: 15px;">
                <div style="font-size: 14px; font-weight: bold; color: #7c5b53; margin-bottom: 8px;">„Äê${category.category}„Äë</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    ${category.sounds.map(sound => `
                        <button onclick="app.insertAdultSound('${sound.label}')" 
                                style="padding: 12px 8px; background: #c85a8b; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: bold;">
                            ${sound.label}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    });

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header" style="background: linear-gradient(to right, #c85a8b, #d87aa0);">
                <div class="modal-title">üîû „Ç¢„ÉÄ„É´„ÉàÂäπÊûúÈü≥</div>
                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                ${buttonsHtml}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
},

insertAdultSound(soundText) {
    this.insertText(`‚ô°${soundText}//`);
    document.querySelector('.modal').remove();
},

openCreativeSlot() {
    this.showCreativeSlotModal();
},

showCreativeSlotModal() {
    const slotData = {
        Kisetsu: ['Êò•', 'Â§è', 'Áßã', 'ÂÜ¨'],
        Jikan: ['Êúù', 'Êòº', 'Â§ïÊñπ', 'Â§ú', 'Ê∑±Â§ú'],
        Tenkou: ['Êô¥„Çå', 'Êõá„Çä', 'Èõ®', 'Èõ™', 'Âµê'],
        Basho: ['ÂÆ∂', 'Â≠¶Ê†°', '‰ºöÁ§æ', '„Éõ„ÉÜ„É´', 'Ê∏©Ê≥â', '„Éó„Éº„É´'],
        Janru: ['„Éï„Ç°„É≥„Çø„Ç∏„Éº', 'Áèæ‰ª£', 'Êú™Êù•', 'SF', 'Ê≠¥Âè≤', '„Éë„É©„É¨„É´'],
        Kankei: ['ÊÅã‰∫∫', 'Â§´Â©¶', 'Â©öÁ¥ÑËÄÖ', '‰∏çÂÄ´', 'ÂàùÂØæÈù¢', 'Âèã‰∫∫'],
        Aitemo: ['„Å™„Åó', '„É≠„Éº„Ç∑„Éß„É≥', 'ÊâãÈå†', '„Éê„Ç§„Éñ', '„É≠„Éº„Éó', '„Ç¢„Ç§„Éû„Çπ„ÇØ'],
        Sichue: ['ÂÅ∂ÁÑ∂„ÅÆÂá∫‰ºö„ÅÑ', 'ÂØÜÂÆ§', 'ÁõóÊíÆ', 'Âº∑Âà∂', 'ÂêàÊÑè', '‰∫§Ê∏â'],
        PureiA: ['ÂâçÊàØ', '„Ç≠„Çπ', 'ÊÑõÊí´', 'ËÑ±Ë°£', '„Éû„ÉÉ„Çµ„Éº„Ç∏'],
        PureiB: ['ÊåøÂÖ•', '„Éî„Çπ„Éà„É≥', 'È®é‰πó‰Ωç', '„Éê„ÉÉ„ÇØ', 'ÂÅ¥‰Ωç'],
        PureiC: ['„Ç™„Éº„É©„É´', 'Êâã„Ç≥„Ç≠', '„Åù„ÅÆ‰ªñ', '„ÇØ„É≥„Éã', '„Éï„Çß„É©']
    };

    this._slotData = slotData;

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header" style="background: linear-gradient(to right, #a87b5a, #c4a88b);">
                <div class="modal-title">üé∞ Ââµ‰ΩúÊîØÊè¥„Çπ„É≠„ÉÉ„Éà</div>
                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="slotRating" value="general" checked onchange="app.toggleSlotRating()">
                        <span>ÂÖ®Âπ¥ÈΩ¢Âêë„Åë</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="slotRating" value="adult" onchange="app.toggleSlotRating()">
                        <span>Êàê‰∫∫Âêë„Åë</span>
                    </label>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px;">
                    ${this.createSlotItem('Â≠£ÁØÄ', 'Kisetsu')}
                    ${this.createSlotItem('ÊôÇÈñìÂ∏Ø', 'Jikan')}
                    ${this.createSlotItem('Â§©ÂÄô', 'Tenkou')}
                    ${this.createSlotItem('Â†¥ÊâÄ', 'Basho')}
                    ${this.createSlotItem('„Ç∏„É£„É≥„É´', 'Janru')}
                    ${this.createSlotItem('Èñ¢‰øÇ', 'Kankei')}
                    ${this.createSlotItem('„Ç∑„ÉÅ„É•„Ç®„Éº„Ç∑„Éß„É≥', 'Sichue')}
                </div>

                <div id="adultSlotSection" style="display: none; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px;">
                    ${this.createSlotItem('„Ç¢„Ç§„ÉÜ„É†', 'Aitemo')}
                    ${this.createSlotItem('„Éó„É¨„Ç§A (ÂâçÊàØ)', 'PureiA')}
                    ${this.createSlotItem('„Éó„É¨„Ç§B (Êú¨Áï™)', 'PureiB')}
                    ${this.createSlotItem('„Éó„É¨„Ç§C („Åù„ÅÆ‰ªñ)', 'PureiC')}
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="app.spinAllSlots()" 
                            style="flex: 1; padding: 12px; background: #7c5b53; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: bold;">
                        ÂÖ®„Å¶Âõû„Åô
                    </button>
                    <button onclick="app.clearAllSlots()" 
                            style="flex: 1; padding: 12px; background: #999; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: bold;">
                        „ÇØ„É™„Ç¢
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="app.insertSlotToMemo()">„É°„É¢„Å´ÊåøÂÖ•</button>
                <button class="modal-btn modal-btn-secondary" onclick="this.closest('.modal').remove()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
},

createSlotItem(label, key) {
    return `
        <div style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size: 12px; font-weight: bold; color: #7c5b53; margin-bottom: 5px;">${label}</div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <div id="slot-${key}" style="flex: 1; padding: 8px; background: #f9f9f9; border: 1px solid #c4a88b; border-radius: 6px; font-size: 14px; text-align: center; min-height: 36px; display: flex; align-items: center; justify-content: center;"></div>
                <button onclick="app.spinSlot('${key}')" 
                        style="padding: 8px 12px; background: #a87b5a; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold;">
                    üé∞
                </button>
            </div>
        </div>
    `;
},

toggleSlotRating() {
    const isAdult = document.querySelector('input[name="slotRating"]:checked').value === 'adult';
    const adultSection = document.getElementById('adultSlotSection');
    if (isAdult) {
        adultSection.style.display = 'grid';
    } else {
        adultSection.style.display = 'none';
        ['Aitemo', 'PureiA', 'PureiB', 'PureiC'].forEach(key => {
            const elem = document.getElementById(`slot-${key}`);
            if (elem) elem.textContent = '';
        });
    }
},

spinSlot(category) {
    if (!this._slotData || !this._slotData[category]) return;
    
    const items = this._slotData[category];
    const randomItem = items[Math.floor(Math.random() * items.length)];
    
    const resultElem = document.getElementById(`slot-${category}`);
    if (resultElem) {
        resultElem.textContent = randomItem;
    }
},

spinAllSlots() {
    const isAdult = document.querySelector('input[name="slotRating"]:checked').value === 'adult';
    
    ['Kisetsu', 'Jikan', 'Tenkou', 'Basho', 'Janru', 'Kankei', 'Sichue'].forEach(key => {
        this.spinSlot(key);
    });
    
    if (isAdult) {
        ['Aitemo', 'PureiA', 'PureiB', 'PureiC'].forEach(key => {
            this.spinSlot(key);
        });
    }
},

clearAllSlots() {
    ['Kisetsu', 'Jikan', 'Tenkou', 'Basho', 'Janru', 'Kankei', 'Aitemo', 'Sichue', 'PureiA', 'PureiB', 'PureiC'].forEach(key => {
        const elem = document.getElementById(`slot-${key}`);
        if (elem) elem.textContent = '';
    });
},

insertSlotToMemo() {
    const isAdult = document.querySelector('input[name="slotRating"]:checked').value === 'adult';
    
    const getSlotValue = (key) => {
        const elem = document.getElementById(`slot-${key}`);
        return elem ? elem.textContent : '';
    };

    let result = `===== Ââµ‰ΩúÊîØÊè¥„Çπ„É≠„ÉÉ„ÉàÁµêÊûú (${isAdult ? 'Êàê‰∫∫Âêë„Åë' : 'ÂÖ®Âπ¥ÈΩ¢'}) =====\n`;
    result += `‰ΩúÊàêÊó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}\n\n`;
    result += `„Äê„Ç∑„Éº„É≥Ë®≠ÂÆö„Äë\n`;
    result += `Â≠£ÁØÄ: ${getSlotValue('Kisetsu')}\n`;
    result += `ÊôÇÈñìÂ∏Ø: ${getSlotValue('Jikan')}\n`;
    result += `Â§©ÂÄô: ${getSlotValue('Tenkou')}\n`;
    result += `Â†¥ÊâÄ: ${getSlotValue('Basho')}\n\n`;
    result += `„Äê„Çπ„Éà„Éº„É™„ÉºË¶ÅÁ¥†„Äë\n`;
    result += `„Ç∏„É£„É≥„É´: ${getSlotValue('Janru')}\n`;
    result += `Èñ¢‰øÇ: ${getSlotValue('Kankei')}\n`;
    
    if (isAdult) {
        result += `„Ç¢„Ç§„ÉÜ„É†: ${getSlotValue('Aitemo')}\n`;
    }
    
    result += `„Ç∑„ÉÅ„É•„Ç®„Éº„Ç∑„Éß„É≥: ${getSlotValue('Sichue')}\n`;
    
    if (isAdult) {
        result += `\n„Äê„Éó„É¨„Ç§ÂÜÖÂÆπ„Äë\n`;
        result += `„Éó„É¨„Ç§A: ${getSlotValue('PureiA')}\n`;
        result += `„Éó„É¨„Ç§B: ${getSlotValue('PureiB')}\n`;
        result += `„Éó„É¨„Ç§C: ${getSlotValue('PureiC')}\n`;
    }
    
    result += `================================\n`;

    const memoEditor = document.getElementById('memoEditorTab');
    const currentMemo = memoEditor.value;
    
    if (currentMemo) {
        memoEditor.value = currentMemo + '\n\n' + result;
    } else {
        memoEditor.value = result;
    }
    
    if (this.currentProject) {
        localStorage.setItem(`memo_${this.currentProject}`, memoEditor.value);
    }
    
    document.querySelector('.modal').remove();
    this.switchTab(2);
},

openReplace() {
    this.showReplaceModal();
},

showReplaceModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-height: 85vh;">
            <div class="modal-header">
                <div class="modal-title">üîÑ ÊñáÂ≠óÁΩÆÊèõ</div>
                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #7c5b53;">ÁΩÆÊèõÂâç„ÅÆÊñáÂ≠óÂàóÔºà1Ë°å„Å´1„Å§Ôºâ</div>
                    <textarea id="replaceFromText" 
                              style="width: 100%; height: 120px; padding: 10px; border: 1px solid #c4a88b; border-radius: 8px; font-size: 13px; resize: vertical; background: white;" 
                              placeholder="‰æãÔºö&#10;Â§™ÈÉé&#10;Ëä±Â≠ê&#10;Ê¨°ÈÉé"></textarea>
                    <div style="font-size: 11px; color: #666; margin-top: 5px; line-height: 1.4;">
                        üí° Ë§áÊï∞„ÅÆÊñáÂ≠óÂàó„Çí‰∏ÄÂ∫¶„Å´ÁΩÆÊèõ„Åß„Åç„Åæ„Åô„ÄÇ1Ë°å„Å´1„Å§„Åö„Å§ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #7c5b53;">ÁΩÆÊèõÂæå„ÅÆÊñáÂ≠óÂàóÔºà1Ë°å„Å´1„Å§Ôºâ</div>
                    <textarea id="replaceToText" 
                              style="width: 100%; height: 120px; padding: 10px; border: 1px solid #c4a88b; border-radius: 8px; font-size: 13px; resize: vertical; background: white;" 
                              placeholder="‰æãÔºö&#10;Áî∞‰∏≠Â§™ÈÉé&#10;‰ΩêËó§Ëä±Â≠ê&#10;Èà¥Êú®Ê¨°ÈÉé"></textarea>
                    <div style="font-size: 11px; color: #666; margin-top: 5px; line-height: 1.4;">
                        ‚ö†Ô∏è ÁΩÆÊèõÂâç„Å®Âêå„ÅòË°åÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="replaceRange" value="current" checked>
                        <span>ÁèæÂú®„ÅÆ„Ç∑„Éº„É≥„ÅÆ„Åø</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="replaceRange" value="all">
                        <span>ÂÖ®„Ç∑„Éº„É≥</span>
                    </label>
                </div>

                <div id="replaceResult" style="padding: 10px; background: white; border-radius: 8px; font-size: 12px; min-height: 40px; margin-bottom: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="app.executeReplace()">ÁΩÆÊèõÂÆüË°å</button>
                <button class="modal-btn modal-btn-secondary" onclick="this.closest('.modal').remove()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
},

executeReplace() {
    const fromText = document.getElementById('replaceFromText').value;
    const toText = document.getElementById('replaceToText').value;
    const range = document.querySelector('input[name="replaceRange"]:checked').value;
    const resultDiv = document.getElementById('replaceResult');

    if (!fromText.trim()) {
        resultDiv.innerHTML = '<span style="color: orange;">‚ö†Ô∏è ÁΩÆÊèõÂâç„ÅÆÊñáÂ≠óÂàó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</span>';
        return;
    }

    const fromLines = fromText.split('\n');
    const toLines = toText.split('\n');

    if (fromLines.length !== toLines.length) {
        resultDiv.innerHTML = `<span style="color: red;">‚ùå „Ç®„É©„Éº: ÁΩÆÊèõÂâçÔºà${fromLines.length}Ë°åÔºâ„Å®ÁΩÆÊèõÂæåÔºà${toLines.length}Ë°åÔºâ„ÅÆË°åÊï∞„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì„ÄÇ</span>`;
        return;
    }

    const replacePairs = [];
    for (let i = 0; i < fromLines.length; i++) {
        if (fromLines[i]) {
            replacePairs.push({
                from: fromLines[i],
                to: toLines[i] || ''
            });
        }
    }

    if (replacePairs.length === 0) {
        resultDiv.innerHTML = '<span style="color: orange;">‚ö†Ô∏è ÊúâÂäπ„Å™ÁΩÆÊèõ„Éö„Ç¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</span>';
        return;
    }

    let totalReplacedCount = 0;
    let affectedScenes = 0;

    const sections = range === 'current' 
        ? [this.cuts[this.currentCut]]
        : this.cuts;

    sections.forEach((section, index) => {
        if (!section.content) return;
        
        let content = section.content;
        let sectionReplacedCount = 0;

        replacePairs.forEach(pair => {
            const regex = new RegExp(pair.from.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
            const matches = content.match(regex);
            const count = matches ? matches.length : 0;
            
            if (count > 0) {
                content = content.split(pair.from).join(pair.to);
                sectionReplacedCount += count;
            }
        });

        if (sectionReplacedCount > 0) {
            section.content = content;
            totalReplacedCount += sectionReplacedCount;
            affectedScenes++;

            if (range === 'current' || index === this.currentCut) {
                document.getElementById('contentEditor').value = content;
                this.saveCutContent();
                this.updateCharCount();
            }
        }
    });

    if (totalReplacedCount > 0) {
        const rangeText = range === 'current' ? 'ÁèæÂú®„ÅÆ„Ç∑„Éº„É≥' : `${affectedScenes}ÂÄã„ÅÆ„Ç∑„Éº„É≥`;
        resultDiv.innerHTML = `<span style="color: green; font-weight: bold;">‚úì ${rangeText}„Åß ${totalReplacedCount} ÁÆáÊâÄ„ÇíÁΩÆÊèõ„Åó„Åæ„Åó„Åü„ÄÇ</span>`;
    } else {
        resultDiv.innerHTML = '<span style="color: orange;">Ë©≤ÂΩì„Åô„ÇãÊñáÂ≠óÂàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</span>';
    }
},

openDialogueNumbers() {
    const editor = document.getElementById('contentEditor');
    const currentText = editor.value;

    if (!currentText) {
        alert('„ÉÜ„Ç≠„Çπ„Éà„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
        return;
    }

    try {
        const regexLeadingNumber = /^\s*(\d{3})\s+/;
        let lines = currentText.split('\n');
        let firstNumber = null;

        for (let i = 0; i < lines.length; i++) {
            const match = lines[i].match(regexLeadingNumber);
            if (match && !firstNumber) {
                firstNumber = parseInt(match[1]);
            }
            lines[i] = lines[i].replace(regexLeadingNumber, '');
        }

        const regexA_NameColon = /^\s*[^Ôºö\r\n]+Ôºö/;
        const regexB_NameOpenQ = /^\s*[^„Äå\r\n]+„Äå/;
        const regexC_HashWord = /^\s*ÔºÉ\S+/;

        let counter = firstNumber || 1;
        let dialogCount = 0;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            const isDialog = 
                regexA_NameColon.test(line) ||
                regexB_NameOpenQ.test(line) ||
                regexC_HashWord.test(line);

            if (isDialog) {
                lines[i] = String(counter).padStart(3, '0') + ' ' + line;
                counter++;
                dialogCount++;
            }
        }

        const result = lines.join('\n');
        editor.value = result;
        
        this.saveCutContent();
        this.updateCharCount();

        const startMsg = firstNumber ? `Ôºà${String(firstNumber).padStart(3, '0')}„Åã„ÇâÈñãÂßãÔºâ` : 'Ôºà001„Åã„ÇâÈñãÂßãÔºâ';
        alert(`‚úÖ Âè∞Ë©û„Å´ÈÄ£Áï™„Çí‰ªò‰∏é„Åó„Åæ„Åó„Åü„ÄÇ${startMsg}\nÂè∞Ë©ûÊï∞: ${dialogCount}‰ª∂`);

    } catch (ex) {
        alert(`Âè∞Ë©ûÈÄ£Áï™‰ªò‰∏é‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${ex.message}`);
    }
},
    
showAnalysis() {
    this.showAnalysisModal();
},

showAnalysisModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-title">üìä ÂàÜÊûê„ÉÑ„Éº„É´</div>
                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body" style="overflow-y: auto; padding: 20px;">
                <!-- ÊñáÂ≠óÊï∞Ë®àÁÆó„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div style="margin-bottom: 30px;">
                    <div style="font-size: 16px; font-weight: bold; color: #7c5b53; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e7d0a9;">
                        üí∞ ÊñáÂ≠óÊï∞Ë®àÁÆó
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 13px; font-weight: bold; color: #7c5b53; margin-bottom: 5px;">
                            Âçò‰æ°ÔºàÂÜÜ/ÊñáÂ≠óÔºâ
                        </label>
                        <input type="number" id="charPriceInput" value="1" min="0" step="0.1" 
                               style="width: 100%; padding: 10px; border: 1px solid #c4a88b; border-radius: 8px; font-size: 14px;">
                    </div>
                    
                    <button onclick="app.calculateCharStats()" 
                            style="width: 100%; padding: 12px; background: #7c5b53; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; margin-bottom: 15px;">
                        Ë®àÁÆó
                    </button>
                    
                    <div id="charStatsResult" style="display: none;">
                        <div id="charStatsCards" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;"></div>
                        <div id="charStatsTable"></div>
                    </div>
                </div>
                
                <!-- Â£∞ÂÑ™‰æùÈ†ºÊñá„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div>
                    <div style="font-size: 16px; font-weight: bold; color: #7c5b53; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e7d0a9;">
                        üìù Â£∞ÂÑ™‰æùÈ†ºÊñáÁîüÊàê
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-size: 13px; font-weight: bold; color: #7c5b53; margin-bottom: 5px;">
                            Â£∞ÂÑ™Âçò‰æ°ÔºàÂÜÜ/ÊñáÂ≠óÔºâ
                        </label>
                        <input type="number" id="voicePriceInput" value="1" min="0" step="0.1"
                               style="width: 100%; padding: 10px; border: 1px solid #c4a88b; border-radius: 8px; font-size: 14px;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: bold; color: #7c5b53; margin-bottom: 5px;">
                                Á∑†„ÇÅÂàá„Çä
                            </label>
                            <input type="date" id="voiceDeadlineInput"
                                   style="width: 100%; padding: 10px; border: 1px solid #c4a88b; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: bold; color: #7c5b53; margin-bottom: 5px;">
                                ÊîØÊâïÊó•
                            </label>
                            <input type="date" id="voicePaymentInput"
                                   style="width: 100%; padding: 10px; border: 1px solid #c4a88b; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <button onclick="app.generateVoiceRequest()" 
                            style="width: 100%; padding: 12px; background: #c85a8b; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; margin-bottom: 15px;">
                        ‰æùÈ†ºÊñáÁîüÊàê
                    </button>
                    
                    <div id="voiceRequestResult" style="display: none;">
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; max-height: 400px; overflow-y: auto; margin-bottom: 15px;" id="voiceRequestPreview"></div>
                        <button onclick="app.copyVoiceRequest()" 
                                style="width: 100%; padding: 12px; background: #6b8b5a; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: bold;">
                            üìã „Ç≥„Éî„Éº
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // „Éá„Éï„Ç©„É´„ÉàÊó•‰ªòË®≠ÂÆö
    const today = new Date();
    const deadline = new Date(today);
    deadline.setDate(deadline.getDate() + 14);
    const payment = new Date(today);
    payment.setDate(payment.getDate() + 21);
    
    document.getElementById('voiceDeadlineInput').value = deadline.toISOString().split('T')[0];
    document.getElementById('voicePaymentInput').value = payment.toISOString().split('T')[0];
    
    this.hideMenu();
},

calculateCharStats() {
    const charPrice = parseFloat(document.getElementById('charPriceInput').value) || 1;
    
    const charDict = {};
    
    this.cuts.forEach(section => {
        if (!section.content) return;
        
        const lines = section.content.split('\n');
        
        lines.forEach(line => {
            const trimmed = line.trim();
            const lineWithoutNumber = trimmed.replace(/^\d{3}\s+/, '').trim();
            
            if (lineWithoutNumber.startsWith('‚òÜÂäπÊûúÈü≥') ||
                lineWithoutNumber.startsWith('‚òÜBGM') ||
                lineWithoutNumber.startsWith('‚òÜÁí∞Â¢ÉÈü≥')) {
                return;
            }
            
            let charName = null;
            let dialogue = null;
            
            if (lineWithoutNumber.includes('Ôºö')) {
                const colonIndex = lineWithoutNumber.indexOf('Ôºö');
                charName = lineWithoutNumber.substring(0, colonIndex).trim();
                dialogue = lineWithoutNumber.substring(colonIndex + 1).trim();
            } else if (lineWithoutNumber.match(/^([^„Äå]+)„Äå(.+)„Äç$/)) {
                const match = lineWithoutNumber.match(/^([^„Äå]+)„Äå(.+)„Äç$/);
                charName = match[1].trim();
                dialogue = match[2];
            }
            
            if (charName && dialogue) {
                if (!charDict[charName]) charDict[charName] = 0;
                charDict[charName] += dialogue.length;
            }
        });
    });
    
    const totalChars = Object.values(charDict).reduce((sum, count) => sum + count, 0);
    const totalPrice = totalChars * charPrice;
    const charCount = Object.keys(charDict).length;
    
    // „Ç´„Éº„ÉâË°®Á§∫
    const cards = document.getElementById('charStatsCards');
    cards.innerHTML = `
        <div style="background: linear-gradient(135deg, #7c5b53 0%, #a0795f 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 10px; color: #e7d0a9; margin-bottom: 5px;">Á∑èÊñáÂ≠óÊï∞</div>
            <div style="font-size: 20px; font-weight: bold;">${totalChars.toLocaleString()}</div>
            <div style="font-size: 11px; color: #e7d0a9;">ÊñáÂ≠ó</div>
        </div>
        <div style="background: linear-gradient(135deg, #7c5b53 0%, #a0795f 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 10px; color: #e7d0a9; margin-bottom: 5px;">„Ç≠„É£„É©Êï∞</div>
            <div style="font-size: 20px; font-weight: bold;">${charCount}</div>
            <div style="font-size: 11px; color: #e7d0a9;">‰∫∫</div>
        </div>
        <div style="background: linear-gradient(135deg, #7c5b53 0%, #a0795f 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 10px; color: #e7d0a9; margin-bottom: 5px;">ÂêàË®àÈáëÈ°ç</div>
            <div style="font-size: 20px; font-weight: bold;">¬•${totalPrice.toLocaleString()}</div>
        </div>
    `;
    
    // „ÉÜ„Éº„Éñ„É´Ë°®Á§∫
    let table = '<div style="overflow-x: auto; margin-top: 15px;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
    table += '<thead><tr style="background: #7c5b53; color: white;"><th style="padding: 10px; text-align: left;">„Ç≠„É£„É©„ÇØ„Çø„Éº</th><th style="padding: 10px; text-align: right;">ÊñáÂ≠óÊï∞</th><th style="padding: 10px; text-align: right;">ÈáëÈ°ç</th></tr></thead><tbody>';
    
    Object.entries(charDict)
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, count], index) => {
            const price = count * charPrice;
            const bgColor = index % 2 === 0 ? '#f9f9f9' : 'white';
            table += `<tr style="background: ${bgColor}; border-bottom: 1px solid #e0e0e0;"><td style="padding: 8px;"><strong>${name}</strong></td><td style="padding: 8px; text-align: right;">${count.toLocaleString()}ÊñáÂ≠ó</td><td style="padding: 8px; text-align: right;">¬•${price.toLocaleString()}</td></tr>`;
        });
    
    table += '</tbody></table></div>';
    
    document.getElementById('charStatsTable').innerHTML = table;
    document.getElementById('charStatsResult').style.display = 'block';
    
    this._currentCharStats = { charDict, totalChars, totalPrice, charCount, charPrice };
},

generateVoiceRequest() {
    const voicePrice = parseFloat(document.getElementById('voicePriceInput').value) || 1;
    const deadline = document.getElementById('voiceDeadlineInput').value;
    const payment = document.getElementById('voicePaymentInput').value;
    
    const charDict = {};
    const lineNumbers = {};
    
    this.cuts.forEach((section) => {
        if (!section.content) return;
        
        const lines = section.content.split('\n');
        let lineNumber = 1;
        
        lines.forEach(line => {
            const trimmed = line.trim();
            const lineWithoutNumber = trimmed.replace(/^\d{3}\s+/, '').trim();
            
            if (lineWithoutNumber.startsWith('‚òÜÂäπÊûúÈü≥') ||
                lineWithoutNumber.startsWith('‚òÜBGM') ||
                lineWithoutNumber.startsWith('‚òÜÁí∞Â¢ÉÈü≥')) {
                return;
            }
            
            const hasNumber = /^\d{3}\s+/.test(trimmed);
            
            if (hasNumber) {
                let charName = null;
                let dialogue = null;
                
                if (lineWithoutNumber.includes('Ôºö')) {
                    const colonIndex = lineWithoutNumber.indexOf('Ôºö');
                    charName = lineWithoutNumber.substring(0, colonIndex).trim();
                    dialogue = lineWithoutNumber.substring(colonIndex + 1).trim();
                } else if (lineWithoutNumber.match(/^([^„Äå]+)„Äå(.+)„Äç$/)) {
                    const match = lineWithoutNumber.match(/^([^„Äå]+)„Äå(.+)„Äç$/);
                    charName = match[1].trim();
                    dialogue = match[2];
                }
                
                if (charName && dialogue) {
                    if (!charDict[charName]) {
                        charDict[charName] = 0;
                        lineNumbers[charName] = [];
                    }
                    charDict[charName] += dialogue.length;
                    lineNumbers[charName].push(String(lineNumber).padStart(3, '0'));
                }
                
                lineNumber++;
            }
        });
    });
    
    let request = '„Åä‰∏ñË©±„Å´„Å™„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ\n\n';
    request += '„Åì„ÅÆÂ∫¶„ÄÅÈü≥Â£∞ÂèéÈå≤„ÅÆ„ÅîÊ°àÂÜÖ„Çí„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åü„ÅèÈÄ£Áµ°„ÅÑ„Åü„Åó„Åæ„Åó„Åü„ÄÇ\n';
    request += '‰∏ãË®ò„ÅÆÂÜÖÂÆπ„Å´„Å¶ÂèéÈå≤„ÅÆ‰∏ä„ÄÅ„ÅîÊèêÂá∫„ÅÑ„Åü„Å†„Åë„Åæ„Åô„Å®Âπ∏„ÅÑ„Åß„Åô„ÄÇ\n\n';
    request += '„Äê„Åî‰æùÈ†ºÂÜÖÂÆπ„Äë\n';
    request += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
    
    Object.entries(charDict)
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, count]) => {
            const price = count * voicePrice;
            const lines = lineNumbers[name] || [];
            
            request += `‚ñ† „Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç\n`;
            request += `  ${name}\n\n`;
            request += `‚ñ† ÂèéÈå≤ÊñáÂ≠óÊï∞\n`;
            request += `  ${count.toLocaleString()}ÊñáÂ≠ó\n\n`;
            
            if (lines.length > 0) {
                request += `‚ñ† ÂèéÈå≤ÂØæË±°„Çª„É™„ÉïÁï™Âè∑\n`;
                lines.forEach(line => {
                    request += `  ${line}\n`;
                });
                request += '\n';
            }
            
            request += `‚ñ† „ÅäÊîØÊâï„ÅÑÈáëÈ°ç\n`;
            request += `  ¬•${price.toLocaleString()}ÔºàÂçò‰æ°Ôºö¬•${voicePrice}/ÊñáÂ≠óÔºâ\n\n`;
        });
    
    request += `‚ñ† Á¥çÂìÅÊúüÈôê\n`;
    request += `  ${deadline}„Åæ„Åß\n\n`;
    request += `‚ñ† „ÅäÊîØÊâï„ÅÑÊúüÊó•\n`;
    request += `  ${payment}\n`;
    request += `  ‚ÄªÁ¥çÂìÅÁ¢∫Ë™çÂæå„ÄÅ‰∏äË®òÊúüÊó•„Åæ„Åß„Å´„ÅäÊîØÊâï„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô\n\n`;
    request += `‚ñ† Èü≥Â£∞ÂΩ¢Âºè\n`;
    request += `  „Éª„Çµ„É≥„Éó„É™„É≥„Ç∞„É¨„Éº„ÉàÔºö48000Hz\n`;
    request += `  „Éª„Éì„ÉÉ„ÉàÊ∑±Â∫¶Ôºö16bit\n`;
    request += `  „Éª„ÉÅ„É£„É≥„Éç„É´Ôºö„É¢„Éé„É©„É´\n`;
    request += `  „Éª„Éï„Ç°„Ç§„É´ÂΩ¢ÂºèÔºöwav\n\n`;
    request += `‚ñ† Á¥çÂìÅÊñπÊ≥ï\n`;
    request += `  „ÇÆ„Ç¨„Éï„Ç°„Ç§„É´‰æø„Åß„ÅÆÊèêÂá∫„Çí„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n\n`;
    request += `‚ñ† Á¥çÂìÅ„Éï„Ç©„É´„ÉÄÂêç\n`;
    request += `  Èü≥Â£∞„Éï„Ç°„Ç§„É´\n\n`;
    request += `‚ñ† „Éï„Ç°„Ç§„É´ÂëΩÂêçË¶èÂâá\n`;
    request += `  „Äå„Çª„É™„ÉïÁï™Âè∑_„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç.wav„Äç„ÅÆÂΩ¢Âºè„Åß„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n`;
    request += `  ‰æãÔºö001_„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç.wav\n\n`;
    request += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
    request += '„ÄêÂèéÈå≤„Å´„ÅÇ„Åü„Å£„Å¶„ÅÆ„ÅäÈ°ò„ÅÑ„Äë\n';
    request += '„Éª„Éé„Ç§„Ç∫„ÅåÂÖ•„Çâ„Å™„ÅÑÈùô„Åã„Å™Áí∞Â¢É„Åß„ÅÆÂèéÈå≤„Çí„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n';
    request += '„ÉªÂêÑ„Éï„Ç°„Ç§„É´„ÅÆÂÜíÈ†≠„Å®Êú´Â∞æ„Å´0.5ÁßíÁ®ãÂ∫¶„ÅÆÁÑ°Èü≥ÈÉ®ÂàÜ„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n';
    request += '„Éª„É™„ÉÜ„Ç§„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂà•„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n';
    request += '„Åî‰∏çÊòé„Å™ÁÇπ„Åå„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„Çâ„ÄÅ„ÅäÊ∞óËªΩ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ\n';
    request += '„ÅäÂøô„Åó„ÅÑ„Å®„Åì„ÇçÊÅê„ÇåÂÖ•„Çä„Åæ„Åô„Åå„ÄÅ„ÅîÁ¢∫Ë™ç„ÅÆ„Åª„Å©„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n\n';
    request += '‰ΩïÂçí„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ';
    
    document.getElementById('voiceRequestPreview').textContent = request;
    document.getElementById('voiceRequestResult').style.display = 'block';
    this._currentVoiceRequest = request;
},

copyVoiceRequest() {
    if (!this._currentVoiceRequest) {
        alert('ÂÖà„Å´‰æùÈ†ºÊñá„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(this._currentVoiceRequest).then(() => {
            alert('‚úÖ ‰æùÈ†ºÊñá„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
        }).catch(() => {
            this.fallbackCopy(this._currentVoiceRequest);
        });
    } else {
        this.fallbackCopy(this._currentVoiceRequest);
    }
},

fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    
    try {
        document.execCommand('copy');
        alert('‚úÖ ‰æùÈ†ºÊñá„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
    } catch (err) {
        alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
    
    document.body.removeChild(textarea);
},    
    downloadFile(content, filename, mimeType) {
        this.copyToClipboardWithInstructions(content, filename);
    },
    
    copyToClipboardWithInstructions(content, filename) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(content).then(() => {
                this.showSaveInstructions(filename);
            }).catch(err => {
                console.error('Clipboard error:', err);
                this.copyToClipboardFallback(content, filename);
            });
        } else {
            this.copyToClipboardFallback(content, filename);
        }
    },
    
    showSaveInstructions(filename) {
        const isProject = filename.endsWith('.vwp');
        
        let message = `‚úÖ „Äå${filename}„Äç„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ\n\n`;
        
        if (isProject) {
            message += `„Äê„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰øùÂ≠òÊñπÊ≥ï„Äë\n\n`;
            message += `1Ô∏è‚É£ „É°„É¢„Ç¢„Éó„É™„ÇíÈñã„Åè\n`;
            message += `2Ô∏è‚É£ Êñ∞Ë¶è„É°„É¢„Çí‰ΩúÊàê\n`;
            message += `3Ô∏è‚É£ Èï∑Êäº„Åó„Åó„Å¶„Äå„Éö„Éº„Çπ„Éà„Äç\n`;
            message += `4Ô∏è‚É£ „Çø„Ç§„Éà„É´„Çí„Äå${filename}„Äç„Å´Â§âÊõ¥\n`;
            message += `5Ô∏è‚É£ ‰øùÂ≠òÂÆå‰∫ÜÔºÅ\n\n`;
            message += `„ÄêË™≠„ÅøËæº„ÅøÊñπÊ≥ï„Äë\n`;
            message += `„É°„Éã„É•„Éº ‚Üí „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÄ ‚Üí „É°„É¢„ÅÆÂÜÖÂÆπ„ÇíÂÖ®ÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº ‚Üí „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´Ë≤º„Çä‰ªò„Åë ‚Üí Ë™≠„ÅøËæº„ÇÄ„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó\n\n`;
            message += `üí° „É°„Éº„É´„ÅßËá™ÂàÜÂÆõ„Å´ÈÄÅ‰ø°„Åó„Å¶PC„ÅßÂèó„ÅëÂèñ„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô`;
        } else {
            message += `„Äê„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅÆ‰øùÂ≠òÊñπÊ≥ï„Äë\n\n`;
            message += `1Ô∏è‚É£ „É°„É¢„Ç¢„Éó„É™„ÇíÈñã„Åè\n`;
            message += `2Ô∏è‚É£ Êñ∞Ë¶è„É°„É¢„Çí‰ΩúÊàê\n`;
            message += `3Ô∏è‚É£ Èï∑Êäº„Åó„Åó„Å¶„Äå„Éö„Éº„Çπ„Éà„Äç\n`;
            message += `4Ô∏è‚É£ „Çø„Ç§„Éà„É´„Çí„Äå${filename}„Äç„Å´Â§âÊõ¥\n`;
            message += `5Ô∏è‚É£ ‰øùÂ≠òÂÆå‰∫ÜÔºÅ\n\n`;
            message += `üí° „Åù„ÅÆ„Åæ„Åæ„É°„Éº„É´„ÅßÈÄÅ‰ø°„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô`;
        }
        
        alert(message);
    },
    
    copyToClipboardFallback(content, filename) {
        const textarea = document.createElement('textarea');
        textarea.value = content;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            const success = document.execCommand('copy');
            if (success) {
                this.showSaveInstructions(filename);
            } else {
                alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        } catch (err) {
            alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        }
        
        document.body.removeChild(textarea);
    }
};

document.addEventListener('DOMContentLoaded', () => {
    app.init();
});

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw-mobile.js')
            .then(reg => console.log('SWÁôªÈå≤ÊàêÂäü'))
            .catch(err => console.log('SWÁôªÈå≤Â§±Êïó:', err));
    });
}
    </script>
</body>
</html>






