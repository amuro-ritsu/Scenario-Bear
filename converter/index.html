<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scene*Writer ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #e8dcc8 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(to right, #7c5b53, #a0795f);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .header-subtitle {
            font-size: 14px;
            color: #e7d0a9;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #7c5b53;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e7d0a9;
        }
        .textarea-container {
            position: relative;
        }
        .textarea-label {
            font-size: 14px;
            font-weight: bold;
            color: #7c5b53;
            margin-bottom: 8px;
            display: block;
        }
        .data-textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #c4a88b;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            background: #fafafa;
            line-height: 1.5;
        }
        .data-textarea:focus {
            outline: none;
            border-color: #7c5b53;
            background: white;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-primary {
            background: #7c5b53;
            color: white;
        }
        .btn-primary:hover {
            background: #6a4d45;
        }
        .btn-secondary {
            background: #6b8b5a;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a7a49;
        }
        .btn-danger {
            background: #c85a8b;
            color: white;
        }
        .btn-danger:hover {
            background: #b74a7a;
        }
        .btn-convert {
            background: #4a7c7e;
            color: white;
        }
        .btn-convert:hover {
            background: #3a6c6e;
        }
        .info-box {
            background: #f0e6d2;
            border: 2px solid #e7d0a9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-title {
            font-weight: bold;
            color: #7c5b53;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .info-item {
            font-size: 13px;
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }
        .info-item::before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #7c5b53;
            font-weight: bold;
        }
        .result-box {
            background: #e6f7ff;
            border: 2px solid #91d5ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        .result-box.success {
            background: #f6ffed;
            border-color: #b7eb8f;
        }
        .result-box.error {
            background: #fff1f0;
            border-color: #ffccc7;
        }
        .result-box.warning {
            background: #fffbe6;
            border-color: #ffe58f;
        }
        .result-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .result-box.success .result-title {
            color: #52c41a;
        }
        .result-box.error .result-title {
            color: #ff4d4f;
        }
        .result-box.warning .result-title {
            color: #faad14;
        }
        .result-content {
            font-size: 14px;
            line-height: 1.6;
        }
        .filename-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #c4a88b;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .filename-input:focus {
            outline: none;
            border-color: #7c5b53;
        }
        .format-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .format-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #c4a88b;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .format-option:hover {
            border-color: #7c5b53;
            background: #f9f5f0;
        }
        .format-option.active {
            border-color: #7c5b53;
            background: #7c5b53;
            color: white;
            font-weight: bold;
        }
        .conversion-mode {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f9f5f0;
            padding: 15px;
            border-radius: 10px;
        }
        .mode-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #c4a88b;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .mode-option:hover {
            border-color: #7c5b53;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .mode-option.active {
            border-color: #4a7c7e;
            background: #4a7c7e;
            color: white;
            font-weight: bold;
        }
        .footer {
            background: #f9f5f0;
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 13px;
        }
        .preview-section {
            display: none;
        }
        .preview-section.active {
            display: block;
        }
        .preview-content {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }
        .file-upload-area {
            border: 3px dashed #c4a88b;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        .file-upload-area:hover {
            border-color: #7c5b53;
            background: #f0e6d2;
        }
        .file-upload-area.dragover {
            border-color: #4a7c7e;
            background: #e0f0f0;
        }
        .file-input {
            display: none;
        }
        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
            }
            .format-select {
                flex-direction: column;
            }
            .mode-option {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">ğŸ­ Scene*Writer ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ„ãƒ¼ãƒ«</div>
            <div class="header-subtitle">vwpãƒ•ã‚¡ã‚¤ãƒ«ã¨txtãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ã‚’ç›¸äº’å¤‰æ›ï¼ˆJSONãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰</div>
        </div>

        <div class="content">
            <div class="conversion-mode">
                <div class="mode-option active" onclick="setConversionMode('vwp-to-txt', false)" id="mode-vwp-to-txt">
                    <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“„ â†’ ğŸ“</div>
                    <div style="font-weight: bold;">VWP â†’ TXT</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã«å¤‰æ›</div>
                </div>
                <div class="mode-option" onclick="setConversionMode('txt-to-vwp', false)" id="mode-txt-to-vwp">
                    <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“ â†’ ğŸ“„</div>
                    <div style="font-weight: bold;">TXT â†’ VWP</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆç”¨ã«å¤‰æ›</div>
                </div>
            </div>

            <div class="info-box">
                <div class="info-title" id="info-title">ğŸ“Œ VWP â†’ TXT å¤‰æ›ã«ã¤ã„ã¦</div>
                <div id="info-content">
                    <div class="info-item">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆScene*Writerã§ä½œæˆã—ãŸvwpãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™</div>
                    <div class="info-item">JSONãƒ‡ãƒ¼ã‚¿ã‚’txtæ‹¡å¼µå­ã§ä¿å­˜ã—ã¾ã™</div>
                    <div class="info-item">ã‚¹ãƒãƒ›ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆScene*Writerã§èª­ã¿è¾¼ã¿å¯èƒ½ã«ãªã‚Šã¾ã™</div>
                    <div class="info-item">ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ãã®ã¾ã¾ä¿æŒã•ã‚Œã¾ã™</div>
                </div>
            </div>

            <div class="section">
                <div class="section-title" id="input-section-title">ğŸ“¥ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆVWPãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</div>
                
                <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click();">
                    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“</div>
                    <div style="font-weight: bold; margin-bottom: 5px;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                    <div style="font-size: 12px; color: #666;">vwpãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯txtãƒ•ã‚¡ã‚¤ãƒ«</div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".vwp,.txt,.json">
                
                <label class="textarea-label">ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥è²¼ã‚Šä»˜ã‘ï¼š</label>
                <textarea 
                    id="dataInput" 
                    class="data-textarea" 
                    placeholder="ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
            </div>

            <div class="section">
                <label class="textarea-label">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å</label>
                <input 
                    type="text" 
                    id="filenameInput" 
                    class="filename-input" 
                    placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ï¼ˆæ‹¡å¼µå­ã¯è‡ªå‹•ä»˜ä¸ï¼‰"
                    value="ãƒã‚¤ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ">
            </div>

            <div class="button-group">
                <button class="btn btn-convert" onclick="convertData()">ğŸ”„ å¤‰æ›å®Ÿè¡Œ</button>
                <button class="btn btn-secondary" onclick="previewData()">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                <button class="btn btn-primary" onclick="downloadData()">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
            </div>

            <div id="resultBox" class="result-box"></div>

            <div id="previewSection" class="preview-section">
                <div class="section">
                    <div class="section-title">ğŸ“„ å¤‰æ›çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                    <div id="previewContent" class="preview-content"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>Scene*Writer ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ„ãƒ¼ãƒ«</strong></p>
            <p style="margin-top: 10px;">Â© 2025 Ambrose Starlit</p>
            <p style="margin-top: 10px; font-size: 11px;">ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§å‹•ä½œã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</p>
        </div>
    </div>

    <script>
        let conversionMode = 'vwp-to-txt';
        let convertedData = null;

        function setConversionMode(mode, preserveData = false) {
            conversionMode = mode;
            document.getElementById('mode-vwp-to-txt').classList.remove('active');
            document.getElementById('mode-txt-to-vwp').classList.remove('active');
            document.getElementById('mode-' + mode).classList.add('active');
            
            // æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ã®æ›´æ–°
            const infoTitle = document.getElementById('info-title');
            const infoContent = document.getElementById('info-content');
            const inputTitle = document.getElementById('input-section-title');
            
            if (mode === 'vwp-to-txt') {
                infoTitle.textContent = 'ğŸ“Œ VWP â†’ TXT å¤‰æ›ã«ã¤ã„ã¦';
                inputTitle.textContent = 'ğŸ“¥ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆVWPãƒ•ã‚¡ã‚¤ãƒ«ï¼‰';
                infoContent.innerHTML = `
                    <div class="info-item">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆScene*Writerã§ä½œæˆã—ãŸvwpãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™</div>
                    <div class="info-item">JSONãƒ‡ãƒ¼ã‚¿ã‚’txtæ‹¡å¼µå­ã§ä¿å­˜ã—ã¾ã™</div>
                    <div class="info-item">ã‚¹ãƒãƒ›ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆScene*Writerã§èª­ã¿è¾¼ã¿å¯èƒ½ã«ãªã‚Šã¾ã™</div>
                    <div class="info-item">ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ãã®ã¾ã¾ä¿æŒã•ã‚Œã¾ã™</div>
                `;
            } else {
                infoTitle.textContent = 'ğŸ“Œ TXT â†’ VWP å¤‰æ›ã«ã¤ã„ã¦';
                inputTitle.textContent = 'ğŸ“¥ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆTXTãƒ•ã‚¡ã‚¤ãƒ«ï¼‰';
                infoContent.innerHTML = `
                    <div class="info-item">ãƒ–ãƒ©ã‚¦ã‚¶/ã‚¹ãƒãƒ›ç‰ˆã®txtãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJSONå½¢å¼ï¼‰ã‚’èª­ã¿è¾¼ã¿ã¾ã™</div>
                    <div class="info-item">Scene*Writerå½¢å¼ï¼ˆ.vwpæ‹¡å¼µå­ï¼‰ã«å¤‰æ›ã—ã¾ã™</div>
                    <div class="info-item">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆScene*Writerã§èª­ã¿è¾¼ã¿å¯èƒ½ã«ãªã‚Šã¾ã™</div>
                    <div class="info-item">ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã¦å¤‰æ›ã—ã¾ã™</div>
                `;
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ™‚ã¯ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã€æ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã¿ã‚¯ãƒªã‚¢
            if (!preserveData) {
                clearAll(true);
            } else {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨çµæœã ã‘ã‚¯ãƒªã‚¢
                document.getElementById('previewSection').classList.remove('active');
                convertedData = null;
                hideResult();
            }
        }

        function validateJSON(text) {
            try {
                const data = JSON.parse(text);
                if (!data.cuts || !Array.isArray(data.cuts)) {
                    return { valid: false, error: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆcutsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå¿…è¦ã§ã™ï¼‰' };
                }
                return { valid: true, data: data };
            } catch (e) {
                return { valid: false, error: 'JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ' + e.message };
            }
        }

        function generateTxtFromVWP(data) {
            // JSONãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¿”ã™ï¼ˆã‚¹ãƒãƒ›/ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆã§èª­ã¿è¾¼ã¿å¯èƒ½ï¼‰
            return JSON.stringify(data, null, 2);
        }

        function parseTextToVWP(text) {
            // ã¾ãšJSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
            try {
                const data = JSON.parse(text);
                // æœ‰åŠ¹ãªvwpãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‹ãƒã‚§ãƒƒã‚¯
                if (data.cuts && Array.isArray(data.cuts)) {
                    return data;
                }
            } catch (e) {
                // JSONã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                console.log('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†');
            }

            // JSONã§ãªã„å ´åˆã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰åŸºæœ¬æ§‹é€ ã‚’ä½œæˆ
            const lines = text.split('\n');
            const data = {
                title: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
                globalSynopsis: '',
                characters: [],
                cuts: [{
                    name: 'ãƒ¡ã‚¤ãƒ³ã‚·ãƒŠãƒªã‚ª',
                    synopsis: '',
                    content: text.trim()
                }]
            };

            return data;
        }

        function convertData() {
            const textarea = document.getElementById('dataInput');
            const input = textarea.value.trim();
            
            console.log('å¤‰æ›é–‹å§‹ - å…¥åŠ›ãƒ‡ãƒ¼ã‚¿é•·:', input.length);
            console.log('å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®100æ–‡å­—:', input.substring(0, 100));
            
            if (!input || input.length === 0) {
                showResult('error', 'âŒ ã‚¨ãƒ©ãƒ¼', 'ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã¾ãŸã¯è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                return;
            }

            try {
                if (conversionMode === 'vwp-to-txt') {
                    // VWP â†’ TXTå¤‰æ›
                    const validation = validateJSON(input);
                    if (!validation.valid) {
                        showResult('error', 'âŒ ã‚¨ãƒ©ãƒ¼', validation.error);
                        return;
                    }
                    convertedData = generateTxtFromVWP(validation.data);
                    showResult('success', 'âœ… å¤‰æ›æˆåŠŸ', 'VWPãƒ•ã‚¡ã‚¤ãƒ«ã‚’TXTå½¢å¼ï¼ˆJSONï¼‰ã§ä¿å­˜å¯èƒ½ã«ã—ã¾ã—ãŸ');
                } else {
                    // TXT â†’ VWPå¤‰æ›
                    convertedData = JSON.stringify(parseTextToVWP(input), null, 2);
                    showResult('success', 'âœ… å¤‰æ›æˆåŠŸ', 'TXTãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJSONï¼‰ã‚’VWPå½¢å¼ã«å¤‰æ›ã—ã¾ã—ãŸ');
                }
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                document.getElementById('previewContent').textContent = convertedData.substring(0, 2000) + 
                    (convertedData.length > 2000 ? '\n\n... (çœç•¥) ...' : '');
                document.getElementById('previewSection').classList.add('active');
                
            } catch (e) {
                console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', e);
                showResult('error', 'âŒ ã‚¨ãƒ©ãƒ¼', 'å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            }
        }

        function previewData() {
            const input = document.getElementById('dataInput').value.trim();

            if (!input) {
                showResult('error', 'âŒ ã‚¨ãƒ©ãƒ¼', 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                document.getElementById('previewSection').classList.remove('active');
                return;
            }

            // è‡ªå‹•å¤‰æ›ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            convertData();
        }

        function downloadData() {
            if (!convertedData) {
                // å¤‰æ›ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…ˆã«å¤‰æ›ã‚’å®Ÿè¡Œ
                convertData();
                if (!convertedData) return;
            }

            const filename = document.getElementById('filenameInput').value.trim() || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ';
            let extension, mimeType;

            if (conversionMode === 'vwp-to-txt') {
                extension = '.txt';
                mimeType = 'text/plain';
            } else {
                extension = '.vwp';
                mimeType = 'application/json';
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
            const blob = new Blob([convertedData], { type: mimeType + ';charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + extension;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showResult('success', 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†', `ã€Œ${filename}${extension}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
        }

        function clearAll(skipConfirm) {
            if (!skipConfirm && !window.confirm('å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            document.getElementById('dataInput').value = '';
            document.getElementById('filenameInput').value = 'ãƒã‚¤ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ';
            document.getElementById('previewSection').classList.remove('active');
            convertedData = null;
            hideResult();
        }

        function showResult(type, title, message) {
            const resultBox = document.getElementById('resultBox');
            resultBox.className = 'result-box ' + type;
            resultBox.innerHTML = `
                <div class="result-title">${title}</div>
                <div class="result-content">${message}</div>
            `;
            resultBox.style.display = 'block';
        }

        function hideResult() {
            document.getElementById('resultBox').style.display = 'none';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›å‡¦ç†
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const content = event.target.result;
                    
                    // ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¨­å®š
                    const textarea = document.getElementById('dataInput');
                    textarea.value = content;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã«åŸºã¥ã„ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’è‡ªå‹•è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰
                    if (file.name.endsWith('.vwp') || file.name.endsWith('.json')) {
                        // vwpã¾ãŸã¯jsonãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼šVWPâ†’TXTå¤‰æ›ãƒ¢ãƒ¼ãƒ‰
                        setConversionMode('vwp-to-txt', true);
                    } else if (file.name.endsWith('.txt')) {
                        // txtãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼šå¸¸ã«TXTâ†’VWPå¤‰æ›ãƒ¢ãƒ¼ãƒ‰
                        setConversionMode('txt-to-vwp', true);
                    }
                    
                    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šèª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
                    console.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', file.name);
                    console.log('ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', content.length, 'æ–‡å­—');
                    console.log('é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰:', conversionMode);
                    
                    showResult('success', 'âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†', `ã€Œ${file.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${content.length}æ–‡å­—ï¼‰`);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ï¼‰
                    e.target.value = '';
                };
                reader.onerror = (error) => {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showResult('error', 'âŒ ã‚¨ãƒ©ãƒ¼', 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                };
                reader.readAsText(file, 'utf-8');
            }
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
        const fileUploadArea = document.getElementById('fileUploadArea');
        const textarea = document.getElementById('dataInput');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const content = event.target.result;
                    
                    // ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¨­å®š
                    const textarea = document.getElementById('dataInput');
                    textarea.value = content;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã«åŸºã¥ã„ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’è‡ªå‹•è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰
                    if (file.name.endsWith('.vwp') || file.name.endsWith('.json')) {
                        // vwpã¾ãŸã¯jsonãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼šVWPâ†’TXTå¤‰æ›ãƒ¢ãƒ¼ãƒ‰
                        setConversionMode('vwp-to-txt', true);
                    } else if (file.name.endsWith('.txt')) {
                        // txtãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼šå¸¸ã«TXTâ†’VWPå¤‰æ›ãƒ¢ãƒ¼ãƒ‰
                        setConversionMode('txt-to-vwp', true);
                    }
                    
                    console.log('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', file.name);
                    console.log('ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', content.length, 'æ–‡å­—');
                    console.log('é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰:', conversionMode);
                    showResult('success', 'âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†', `ã€Œ${file.name}ã€ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã§èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${content.length}æ–‡å­—ï¼‰`);
                };
                reader.onerror = (error) => {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showResult('error', 'âŒ ã‚¨ãƒ©ãƒ¼', 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                };
                reader.readAsText(file, 'utf-8');
            }
        });
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        textarea.addEventListener('dragover', (e) => {
            e.preventDefault();
            textarea.style.borderColor = '#7c5b53';
            textarea.style.background = '#f0e6d2';
        });

        textarea.addEventListener('dragleave', () => {
            textarea.style.borderColor = '#c4a88b';
            textarea.style.background = '#fafafa';
        });

        textarea.addEventListener('drop', (e) => {
            e.preventDefault();
            textarea.style.borderColor = '#c4a88b';
            textarea.style.background = '#fafafa';

            const file = e.dataTransfer.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const content = event.target.result;
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¨­å®š
                    textarea.value = content;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã«åŸºã¥ã„ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’è‡ªå‹•è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰
                    if (file.name.endsWith('.vwp') || file.name.endsWith('.json')) {
                        // vwpã¾ãŸã¯jsonãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼šVWPâ†’TXTå¤‰æ›ãƒ¢ãƒ¼ãƒ‰
                        setConversionMode('vwp-to-txt', true);
                    } else if (file.name.endsWith('.txt')) {
                        // txtãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼šå¸¸ã«TXTâ†’VWPå¤‰æ›ãƒ¢ãƒ¼ãƒ‰
                        setConversionMode('txt-to-vwp', true);
                    }
                    
                    console.log('ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¸ã®èª­ã¿è¾¼ã¿å®Œäº†:', file.name);
                    console.log('ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', content.length, 'æ–‡å­—');
                    console.log('é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰:', conversionMode);
                    showResult('success', 'âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†', `ã€Œ${file.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${content.length}æ–‡å­—ï¼‰`);
                };
                reader.onerror = (error) => {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showResult('error', 'âŒ ã‚¨ãƒ©ãƒ¼', 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                };
                reader.readAsText(file, 'utf-8');
            }
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter ã§å¤‰æ›å®Ÿè¡Œ
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                convertData();
            }
            // Ctrl/Cmd + S ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                downloadData();
            }
        });
    </script>
</body>
</html>
